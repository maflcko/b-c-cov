<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - total_coverage.info - src/wallet/coinselection.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/wallet</a> - coinselection.cpp<span style="font-size: 80%;"> (source / <a href="coinselection.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">total_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">371</td>
            <td class="headerCovTableEntry">378</td>
            <td class="headerCovTableEntryHi">98.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2024-03-25 04:36:56</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntry">35</td>
            <td class="headerCovTableEntryHi">94.3 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">288</td>
            <td class="headerCovTableEntry">360</td>
            <td class="headerCovTableEntryMed">80.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright (c) 2017-2022 The Bitcoin Core developers</a>
<a name="2"><span class="lineNum">       2 </span>                :            : // Distributed under the MIT software license, see the accompanying</a>
<a name="3"><span class="lineNum">       3 </span>                :            : // file COPYING or http://www.opensource.org/licenses/mit-license.php.</a>
<a name="4"><span class="lineNum">       4 </span>                :            : </a>
<a name="5"><span class="lineNum">       5 </span>                :            : #include &lt;wallet/coinselection.h&gt;</a>
<a name="6"><span class="lineNum">       6 </span>                :            : </a>
<a name="7"><span class="lineNum">       7 </span>                :            : #include &lt;common/system.h&gt;</a>
<a name="8"><span class="lineNum">       8 </span>                :            : #include &lt;consensus/amount.h&gt;</a>
<a name="9"><span class="lineNum">       9 </span>                :            : #include &lt;consensus/consensus.h&gt;</a>
<a name="10"><span class="lineNum">      10 </span>                :            : #include &lt;interfaces/chain.h&gt;</a>
<a name="11"><span class="lineNum">      11 </span>                :            : #include &lt;logging.h&gt;</a>
<a name="12"><span class="lineNum">      12 </span>                :            : #include &lt;policy/feerate.h&gt;</a>
<a name="13"><span class="lineNum">      13 </span>                :            : #include &lt;util/check.h&gt;</a>
<a name="14"><span class="lineNum">      14 </span>                :            : #include &lt;util/moneystr.h&gt;</a>
<a name="15"><span class="lineNum">      15 </span>                :            : </a>
<a name="16"><span class="lineNum">      16 </span>                :            : #include &lt;numeric&gt;</a>
<a name="17"><span class="lineNum">      17 </span>                :            : #include &lt;optional&gt;</a>
<a name="18"><span class="lineNum">      18 </span>                :            : #include &lt;queue&gt;</a>
<a name="19"><span class="lineNum">      19 </span>                :            : </a>
<a name="20"><span class="lineNum">      20 </span>                :            : namespace wallet {</a>
<a name="21"><span class="lineNum">      21 </span>                :            : // Common selection error across the algorithms</a>
<a name="22"><span class="lineNum">      22 </span>                :<span class="lineCov">         58 : static util::Result&lt;SelectionResult&gt; ErrorMaxWeightExceeded()</span></a>
<a name="23"><span class="lineNum">      23 </span>                :            : {</a>
<a name="24"><span class="lineNum">      24 </span>                :<span class="lineCov">         58 :     return util::Error{_(&quot;The inputs size exceeds the maximum weight. &quot;</span></a>
<a name="25"><span class="lineNum">      25 </span>                :<span class="lineCov">         58 :                          &quot;Please try sending a smaller amount or manually consolidating your wallet's UTXOs&quot;)};</span></a>
<a name="26"><span class="lineNum">      26 </span>                :            : }</a>
<a name="27"><span class="lineNum">      27 </span>                :            : </a>
<a name="28"><span class="lineNum">      28 </span>                :            : // Sort by descending (effective) value prefer lower waste on tie</a>
<a name="29"><span class="lineNum">      29 </span>                :            : struct {</a>
<a name="30"><span class="lineNum">      30 </span>                :<span class="lineCov">    5739336 :     bool operator()(const OutputGroup&amp; a, const OutputGroup&amp; b) const</span></a>
<a name="31"><span class="lineNum">      31 </span>                :            :     {</a>
<a name="32"><span class="lineNum">      32 </span>        [<span class="branchCov" title="Branch 0 was taken 3042662 times"> + </span><span class="branchCov" title="Branch 1 was taken 2696674 times"> + </span>]:<span class="lineCov">    5739336 :         if (a.GetSelectionAmount() == b.GetSelectionAmount()) {</span></a>
<a name="33"><span class="lineNum">      33 </span>                :            :             // Lower waste is better when effective_values are tied</a>
<a name="34"><span class="lineNum">      34 </span>                :<span class="lineCov">    3042662 :             return (a.fee - a.long_term_fee) &lt; (b.fee - b.long_term_fee);</span></a>
<a name="35"><span class="lineNum">      35 </span>                :            :         }</a>
<a name="36"><span class="lineNum">      36 </span>                :<span class="lineCov">    2696674 :         return a.GetSelectionAmount() &gt; b.GetSelectionAmount();</span></a>
<a name="37"><span class="lineNum">      37 </span>                :            :     }</a>
<a name="38"><span class="lineNum">      38 </span>                :            : } descending;</a>
<a name="39"><span class="lineNum">      39 </span>                :            : </a>
<a name="40"><span class="lineNum">      40 </span>                :            : // Sort by descending (effective) value prefer lower weight on tie</a>
<a name="41"><span class="lineNum">      41 </span>                :            : struct {</a>
<a name="42"><span class="lineNum">      42 </span>                :<span class="lineCov">      45848 :     bool operator()(const OutputGroup&amp; a, const OutputGroup&amp; b) const</span></a>
<a name="43"><span class="lineNum">      43 </span>                :            :     {</a>
<a name="44"><span class="lineNum">      44 </span>        [<span class="branchCov" title="Branch 0 was taken 15089 times"> + </span><span class="branchCov" title="Branch 1 was taken 30759 times"> + </span>]:<span class="lineCov">      45848 :         if (a.GetSelectionAmount() == b.GetSelectionAmount()) {</span></a>
<a name="45"><span class="lineNum">      45 </span>                :            :             // Sort lower weight to front on tied effective_value</a>
<a name="46"><span class="lineNum">      46 </span>                :<span class="lineCov">      15089 :             return a.m_weight &lt; b.m_weight;</span></a>
<a name="47"><span class="lineNum">      47 </span>                :            :         }</a>
<a name="48"><span class="lineNum">      48 </span>                :<span class="lineCov">      30759 :         return a.GetSelectionAmount() &gt; b.GetSelectionAmount();</span></a>
<a name="49"><span class="lineNum">      49 </span>                :            :     }</a>
<a name="50"><span class="lineNum">      50 </span>                :            : } descending_effval_weight;</a>
<a name="51"><span class="lineNum">      51 </span>                :            : </a>
<a name="52"><span class="lineNum">      52 </span>                :            : /*</a>
<a name="53"><span class="lineNum">      53 </span>                :            :  * This is the Branch and Bound Coin Selection algorithm designed by Murch. It searches for an input</a>
<a name="54"><span class="lineNum">      54 </span>                :            :  * set that can pay for the spending target and does not exceed the spending target by more than the</a>
<a name="55"><span class="lineNum">      55 </span>                :            :  * cost of creating and spending a change output. The algorithm uses a depth-first search on a binary</a>
<a name="56"><span class="lineNum">      56 </span>                :            :  * tree. In the binary tree, each node corresponds to the inclusion or the omission of a UTXO. UTXOs</a>
<a name="57"><span class="lineNum">      57 </span>                :            :  * are sorted by their effective values and the tree is explored deterministically per the inclusion</a>
<a name="58"><span class="lineNum">      58 </span>                :            :  * branch first. At each node, the algorithm checks whether the selection is within the target range.</a>
<a name="59"><span class="lineNum">      59 </span>                :            :  * While the selection has not reached the target range, more UTXOs are included. When a selection's</a>
<a name="60"><span class="lineNum">      60 </span>                :            :  * value exceeds the target range, the complete subtree deriving from this selection can be omitted.</a>
<a name="61"><span class="lineNum">      61 </span>                :            :  * At that point, the last included UTXO is deselected and the corresponding omission branch explored</a>
<a name="62"><span class="lineNum">      62 </span>                :            :  * instead. The search ends after the complete tree has been searched or after a limited number of tries.</a>
<a name="63"><span class="lineNum">      63 </span>                :            :  *</a>
<a name="64"><span class="lineNum">      64 </span>                :            :  * The search continues to search for better solutions after one solution has been found. The best</a>
<a name="65"><span class="lineNum">      65 </span>                :            :  * solution is chosen by minimizing the waste metric. The waste metric is defined as the cost to</a>
<a name="66"><span class="lineNum">      66 </span>                :            :  * spend the current inputs at the given fee rate minus the long term expected cost to spend the</a>
<a name="67"><span class="lineNum">      67 </span>                :            :  * inputs, plus the amount by which the selection exceeds the spending target:</a>
<a name="68"><span class="lineNum">      68 </span>                :            :  *</a>
<a name="69"><span class="lineNum">      69 </span>                :            :  * waste = selectionTotal - target + inputs × (currentFeeRate - longTermFeeRate)</a>
<a name="70"><span class="lineNum">      70 </span>                :            :  *</a>
<a name="71"><span class="lineNum">      71 </span>                :            :  * The algorithm uses two additional optimizations. A lookahead keeps track of the total value of</a>
<a name="72"><span class="lineNum">      72 </span>                :            :  * the unexplored UTXOs. A subtree is not explored if the lookahead indicates that the target range</a>
<a name="73"><span class="lineNum">      73 </span>                :            :  * cannot be reached. Further, it is unnecessary to test equivalent combinations. This allows us</a>
<a name="74"><span class="lineNum">      74 </span>                :            :  * to skip testing the inclusion of UTXOs that match the effective value and waste of an omitted</a>
<a name="75"><span class="lineNum">      75 </span>                :            :  * predecessor.</a>
<a name="76"><span class="lineNum">      76 </span>                :            :  *</a>
<a name="77"><span class="lineNum">      77 </span>                :            :  * The Branch and Bound algorithm is described in detail in Murch's Master Thesis:</a>
<a name="78"><span class="lineNum">      78 </span>                :            :  * https://murch.one/wp-content/uploads/2016/11/erhardt2016coinselection.pdf</a>
<a name="79"><span class="lineNum">      79 </span>                :            :  *</a>
<a name="80"><span class="lineNum">      80 </span>                :            :  * @param const std::vector&lt;OutputGroup&gt;&amp; utxo_pool The set of UTXO groups that we are choosing from.</a>
<a name="81"><span class="lineNum">      81 </span>                :            :  *        These UTXO groups will be sorted in descending order by effective value and the OutputGroups'</a>
<a name="82"><span class="lineNum">      82 </span>                :            :  *        values are their effective values.</a>
<a name="83"><span class="lineNum">      83 </span>                :            :  * @param const CAmount&amp; selection_target This is the value that we want to select. It is the lower</a>
<a name="84"><span class="lineNum">      84 </span>                :            :  *        bound of the range.</a>
<a name="85"><span class="lineNum">      85 </span>                :            :  * @param const CAmount&amp; cost_of_change This is the cost of creating and spending a change output.</a>
<a name="86"><span class="lineNum">      86 </span>                :            :  *        This plus selection_target is the upper bound of the range.</a>
<a name="87"><span class="lineNum">      87 </span>                :            :  * @param int max_weight The maximum weight available for the input set.</a>
<a name="88"><span class="lineNum">      88 </span>                :            :  * @returns The result of this coin selection algorithm, or std::nullopt</a>
<a name="89"><span class="lineNum">      89 </span>                :            :  */</a>
<a name="90"><span class="lineNum">      90 </span>                :            : </a>
<a name="91"><span class="lineNum">      91 </span>                :            : static const size_t TOTAL_TRIES = 100000;</a>
<a name="92"><span class="lineNum">      92 </span>                :            : </a>
<a name="93"><span class="lineNum">      93 </span>                :<span class="lineCov">       7951 : util::Result&lt;SelectionResult&gt; SelectCoinsBnB(std::vector&lt;OutputGroup&gt;&amp; utxo_pool, const CAmount&amp; selection_target, const CAmount&amp; cost_of_change,</span></a>
<a name="94"><span class="lineNum">      94 </span>                :            :                                              int max_weight)</a>
<a name="95"><span class="lineNum">      95 </span>                :            : {</a>
<a name="96"><span class="lineNum">      96 </span>                :<span class="lineCov">       7951 :     SelectionResult result(selection_target, SelectionAlgorithm::BNB);</span></a>
<a name="97"><span class="lineNum">      97 </span>                :<span class="lineCov">       7951 :     CAmount curr_value = 0;</span></a>
<a name="98"><span class="lineNum">      98 </span>                :<span class="lineCov">       7951 :     std::vector&lt;size_t&gt; curr_selection; // selected utxo indexes</span></a>
<a name="99"><span class="lineNum">      99 </span>                :<span class="lineCov">       7951 :     int curr_selection_weight = 0; // sum of selected utxo weight</span></a>
<a name="100"><span class="lineNum">     100 </span>                :            : </a>
<a name="101"><span class="lineNum">     101 </span>                :            :     // Calculate curr_available_value</a>
<a name="102"><span class="lineNum">     102 </span>                :<span class="lineCov">       7951 :     CAmount curr_available_value = 0;</span></a>
<a name="103"><span class="lineNum">     103 </span>        [<span class="branchCov" title="Branch 0 was taken 303869 times"> + </span><span class="branchCov" title="Branch 1 was taken 7951 times"> + </span>]:<span class="lineCov">     311820 :     for (const OutputGroup&amp; utxo : utxo_pool) {</span></a>
<a name="104"><span class="lineNum">     104 </span>                :            :         // Assert that this utxo is not negative. It should never be negative,</a>
<a name="105"><span class="lineNum">     105 </span>                :            :         // effective value calculation should have removed it</a>
<a name="106"><span class="lineNum">     106 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 303869 times"> + </span>]:<span class="lineCov">     303869 :         assert(utxo.GetSelectionAmount() &gt; 0);</span></a>
<a name="107"><span class="lineNum">     107 </span>                :<span class="lineCov">     303869 :         curr_available_value += utxo.GetSelectionAmount();</span></a>
<a name="108"><span class="lineNum">     108 </span>                :            :     }</a>
<a name="109"><span class="lineNum">     109 </span>        [<span class="branchCov" title="Branch 0 was taken 389 times"> + </span><span class="branchCov" title="Branch 1 was taken 7562 times"> + </span>]:<span class="lineCov">       7951 :     if (curr_available_value &lt; selection_target) {</span></a>
<a name="110"><span class="lineNum">     110 </span>                :<span class="lineCov">        389 :         return util::Error();</span></a>
<a name="111"><span class="lineNum">     111 </span>                :            :     }</a>
<a name="112"><span class="lineNum">     112 </span>                :            : </a>
<a name="113"><span class="lineNum">     113 </span>                :            :     // Sort the utxo_pool</a>
<a name="114"><span class="lineNum">     114 </span>                :<span class="lineCov">       7562 :     std::sort(utxo_pool.begin(), utxo_pool.end(), descending);</span></a>
<a name="115"><span class="lineNum">     115 </span>                :            : </a>
<a name="116"><span class="lineNum">     116 </span>                :<span class="lineCov">       7562 :     CAmount curr_waste = 0;</span></a>
<a name="117"><span class="lineNum">     117 </span>                :<span class="lineCov">       7562 :     std::vector&lt;size_t&gt; best_selection;</span></a>
<a name="118"><span class="lineNum">     118 </span>                :<span class="lineCov">       7562 :     CAmount best_waste = MAX_MONEY;</span></a>
<a name="119"><span class="lineNum">     119 </span>                :            : </a>
<a name="120"><span class="lineNum">     120 </span>  [<span class="branchCov" title="Branch 0 was taken 7562 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 7562 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       7562 :     bool is_feerate_high = utxo_pool.at(0).fee &gt; utxo_pool.at(0).long_term_fee;</span></a>
<a name="121"><span class="lineNum">     121 </span>                :<span class="lineCov">       7562 :     bool max_tx_weight_exceeded = false;</span></a>
<a name="122"><span class="lineNum">     122 </span>                :            : </a>
<a name="123"><span class="lineNum">     123 </span>                :            :     // Depth First search loop for choosing the UTXOs</a>
<a name="124"><span class="lineNum">     124 </span>        [<span class="branchCov" title="Branch 0 was taken 12617588 times"> + </span><span class="branchCov" title="Branch 1 was taken 122 times"> + </span>]:<span class="lineCov">   12617710 :     for (size_t curr_try = 0, utxo_pool_index = 0; curr_try &lt; TOTAL_TRIES; ++curr_try, ++utxo_pool_index) {</span></a>
<a name="125"><span class="lineNum">     125 </span>                :            :         // Conditions for starting a backtrack</a>
<a name="126"><span class="lineNum">     126 </span>                :<span class="lineCov">   12617588 :         bool backtrack = false;</span></a>
<a name="127"><span class="lineNum">     127 </span>        [<span class="branchCov" title="Branch 0 was taken 11143474 times"> + </span><span class="branchCov" title="Branch 1 was taken 1474114 times"> + </span>]:<span class="lineCov">   12617588 :         if (curr_value + curr_available_value &lt; selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.</span></a>
<a name="128"><span class="lineNum">     128 </span>        [<span class="branchCov" title="Branch 0 was taken 7317896 times"> + </span><span class="branchCov" title="Branch 1 was taken 3825578 times"> + </span>]:<span class="lineCov">   11143474 :             curr_value &gt; selection_target + cost_of_change || // Selected value is out of range, go back and try other branch</span></a>
<a name="129"><span class="lineNum">     129 </span>        [<span class="branchCov" title="Branch 0 was taken 7317892 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">    7317896 :             (curr_waste &gt; best_waste &amp;&amp; is_feerate_high)) { // Don't select things which we know will be more wasteful if the waste is increasing</span></a>
<a name="130"><span class="lineNum">     130 </span>                :            :             backtrack = true;</a>
<a name="131"><span class="lineNum">     131 </span>        [<span class="branchCov" title="Branch 0 was taken 7317806 times"> + </span><span class="branchCov" title="Branch 1 was taken 86 times"> + </span>]:<span class="lineCov">    7317892 :         } else if (curr_selection_weight &gt; max_weight) { // Exceeding weight for standard tx, cannot find more solutions by adding more inputs</span></a>
<a name="132"><span class="lineNum">     132 </span>                :            :             max_tx_weight_exceeded = true; // at least one selection attempt exceeded the max weight</a>
<a name="133"><span class="lineNum">     133 </span>                :            :             backtrack = true;</a>
<a name="134"><span class="lineNum">     134 </span>        [<span class="branchCov" title="Branch 0 was taken 25143 times"> + </span><span class="branchCov" title="Branch 1 was taken 7292663 times"> + </span>]:<span class="lineCov">    7317806 :         } else if (curr_value &gt;= selection_target) {       // Selected value is within range</span></a>
<a name="135"><span class="lineNum">     135 </span>                :<span class="lineCov">      25143 :             curr_waste += (curr_value - selection_target); // This is the excess value which is added to the waste for the below comparison</span></a>
<a name="136"><span class="lineNum">     136 </span>                :            :             // Adding another UTXO after this check could bring the waste down if the long term fee is higher than the current fee.</a>
<a name="137"><span class="lineNum">     137 </span>                :            :             // However we are not going to explore that because this optimization for the waste is only done when we have hit our target</a>
<a name="138"><span class="lineNum">     138 </span>                :            :             // value. Adding any more UTXOs will be just burning the UTXO; it will go entirely to fees. Thus we aren't going to</a>
<a name="139"><span class="lineNum">     139 </span>                :            :             // explore any more UTXOs to avoid burning money like that.</a>
<a name="140"><span class="lineNum">     140 </span>        [<span class="branchCov" title="Branch 0 was taken 12672 times"> + </span><span class="branchCov" title="Branch 1 was taken 12471 times"> + </span>]:<span class="lineCov">      25143 :             if (curr_waste &lt;= best_waste) {</span></a>
<a name="141"><span class="lineNum">     141 </span>        [<span class="branchCov" title="Branch 0 was taken 12672 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      12672 :                 best_selection = curr_selection;</span></a>
<a name="142"><span class="lineNum">     142 </span>                :            :                 best_waste = curr_waste;</a>
<a name="143"><span class="lineNum">     143 </span>                :            :             }</a>
<a name="144"><span class="lineNum">     144 </span>                :<span class="lineCov">      25143 :             curr_waste -= (curr_value - selection_target); // Remove the excess value as we will be selecting different coins now</span></a>
<a name="145"><span class="lineNum">     145 </span>                :<span class="lineCov">      25143 :             backtrack = true;</span></a>
<a name="146"><span class="lineNum">     146 </span>                :            :         }</a>
<a name="147"><span class="lineNum">     147 </span>                :            : </a>
<a name="148"><span class="lineNum">     148 </span>        [<span class="branchCov" title="Branch 0 was taken 5324925 times"> + </span><span class="branchCov" title="Branch 1 was taken 7292663 times"> + </span>]:<span class="lineCov">   12617588 :         if (backtrack) { // Backtracking, moving backwards</span></a>
<a name="149"><span class="lineNum">     149 </span>        [<span class="branchCov" title="Branch 0 was taken 5317485 times"> + </span><span class="branchCov" title="Branch 1 was taken 7440 times"> + </span>]:<span class="lineCov">    5324925 :             if (curr_selection.empty()) { // We have walked back to the first utxo and no branch is untraversed. All solutions searched</span></a>
<a name="150"><span class="lineNum">     150 </span>                :            :                 break;</a>
<a name="151"><span class="lineNum">     151 </span>                :            :             }</a>
<a name="152"><span class="lineNum">     152 </span>                :            : </a>
<a name="153"><span class="lineNum">     153 </span>                :            :             // Add omitted UTXOs back to lookahead before traversing the omission branch of last included UTXO.</a>
<a name="154"><span class="lineNum">     154 </span>        [<span class="branchCov" title="Branch 0 was taken 7004177 times"> + </span><span class="branchCov" title="Branch 1 was taken 5317485 times"> + </span>]:<span class="lineCov">   12321662 :             for (--utxo_pool_index; utxo_pool_index &gt; curr_selection.back(); --utxo_pool_index) {</span></a>
<a name="155"><span class="lineNum">     155 </span>        [<span class="branchCov" title="Branch 0 was taken 7004177 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    7004177 :                 curr_available_value += utxo_pool.at(utxo_pool_index).GetSelectionAmount();</span></a>
<a name="156"><span class="lineNum">     156 </span>                :            :             }</a>
<a name="157"><span class="lineNum">     157 </span>                :            : </a>
<a name="158"><span class="lineNum">     158 </span>                :            :             // Output was included on previous iterations, try excluding now.</a>
<a name="159"><span class="lineNum">     159 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5317485 times"> + </span>]:<span class="lineCov">    5317485 :             assert(utxo_pool_index == curr_selection.back());</span></a>
<a name="160"><span class="lineNum">     160 </span>        [<span class="branchCov" title="Branch 0 was taken 5317485 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5317485 :             OutputGroup&amp; utxo = utxo_pool.at(utxo_pool_index);</span></a>
<a name="161"><span class="lineNum">     161 </span>                :<span class="lineCov">    5317485 :             curr_value -= utxo.GetSelectionAmount();</span></a>
<a name="162"><span class="lineNum">     162 </span>                :<span class="lineCov">    5317485 :             curr_waste -= utxo.fee - utxo.long_term_fee;</span></a>
<a name="163"><span class="lineNum">     163 </span>                :<span class="lineCov">    5317485 :             curr_selection_weight -= utxo.m_weight;</span></a>
<a name="164"><span class="lineNum">     164 </span>                :<span class="lineCov">   12610148 :             curr_selection.pop_back();</span></a>
<a name="165"><span class="lineNum">     165 </span>                :            :         } else { // Moving forwards, continuing down this branch</a>
<a name="166"><span class="lineNum">     166 </span>        [<span class="branchCov" title="Branch 0 was taken 7292663 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    7292663 :             OutputGroup&amp; utxo = utxo_pool.at(utxo_pool_index);</span></a>
<a name="167"><span class="lineNum">     167 </span>                :            : </a>
<a name="168"><span class="lineNum">     168 </span>                :            :             // Remove this utxo from the curr_available_value utxo amount</a>
<a name="169"><span class="lineNum">     169 </span>                :<span class="lineCov">    7292663 :             curr_available_value -= utxo.GetSelectionAmount();</span></a>
<a name="170"><span class="lineNum">     170 </span>                :            : </a>
<a name="171"><span class="lineNum">     171 </span>                :<span class="lineCov">   14467178 :             if (curr_selection.empty() ||</span></a>
<a name="172"><span class="lineNum">     172 </span>                :            :                 // The previous index is included and therefore not relevant for exclusion shortcut</a>
<a name="173"><span class="lineNum">     173 </span>        [<span class="branchCov" title="Branch 0 was taken 5660849 times"> + </span><span class="branchCov" title="Branch 1 was taken 1513666 times"> + </span>]:<span class="lineCov">    7174515 :                 (utxo_pool_index - 1) == curr_selection.back() ||</span></a>
<a name="174"><span class="lineNum">     174 </span>                :            :                 // Avoid searching a branch if the previous UTXO has the same value and same waste and was excluded.</a>
<a name="175"><span class="lineNum">     175 </span>                :            :                 // Since the ratio of fee to long term fee is the same, we only need to check if one of those values match in order to know that the waste is the same.</a>
<a name="176"><span class="lineNum">     176 </span>  [<span class="branchCov" title="Branch 0 was taken 7174515 times"> + </span><span class="branchCov" title="Branch 1 was taken 118148 times"> + </span><span class="branchCov" title="Branch 2 was taken 5660849 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">   12953512 :                 utxo.GetSelectionAmount() != utxo_pool.at(utxo_pool_index - 1).GetSelectionAmount() ||</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 1928136 times"> + </span><span class="branchCov" title="Branch 5 was taken 3732713 times"> + </span>]
<a name="177"><span class="lineNum">     177 </span>  [<span class="branchCov" title="Branch 0 was taken 1928136 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span><span class="branchCov" title="Branch 3 was taken 1928133 times"> + </span>]:<span class="lineCov">    1928136 :                 utxo.fee != utxo_pool.at(utxo_pool_index - 1).fee)</span></a>
<a name="178"><span class="lineNum">     178 </span>                :            :             {</a>
<a name="179"><span class="lineNum">     179 </span>                :            :                 // Inclusion branch first (Largest First Exploration)</a>
<a name="180"><span class="lineNum">     180 </span>        [<span class="branchCov" title="Branch 0 was taken 5364530 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5364530 :                 curr_selection.push_back(utxo_pool_index);</span></a>
<a name="181"><span class="lineNum">     181 </span>                :<span class="lineCov">    5364530 :                 curr_value += utxo.GetSelectionAmount();</span></a>
<a name="182"><span class="lineNum">     182 </span>                :<span class="lineCov">    5364530 :                 curr_waste += utxo.fee - utxo.long_term_fee;</span></a>
<a name="183"><span class="lineNum">     183 </span>                :<span class="lineCov">    5364530 :                 curr_selection_weight += utxo.m_weight;</span></a>
<a name="184"><span class="lineNum">     184 </span>                :            :             }</a>
<a name="185"><span class="lineNum">     185 </span>                :            :         }</a>
<a name="186"><span class="lineNum">     186 </span>                :            :     }</a>
<a name="187"><span class="lineNum">     187 </span>                :            : </a>
<a name="188"><span class="lineNum">     188 </span>                :            :     // Check for solution</a>
<a name="189"><span class="lineNum">     189 </span>        [<span class="branchCov" title="Branch 0 was taken 7428 times"> + </span><span class="branchCov" title="Branch 1 was taken 134 times"> + </span>]:<span class="lineCov">       7562 :     if (best_selection.empty()) {</span></a>
<a name="190"><span class="lineNum">     190 </span>  [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 7408 times"> + </span><span class="branchCov" title="Branch 2 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       7428 :         return max_tx_weight_exceeded ? ErrorMaxWeightExceeded() : util::Error();</span></a>
<a name="191"><span class="lineNum">     191 </span>                :            :     }</a>
<a name="192"><span class="lineNum">     192 </span>                :            : </a>
<a name="193"><span class="lineNum">     193 </span>                :            :     // Set output set</a>
<a name="194"><span class="lineNum">     194 </span>        [<span class="branchCov" title="Branch 0 was taken 27760 times"> + </span><span class="branchCov" title="Branch 1 was taken 134 times"> + </span>]:<span class="lineCov">      27894 :     for (const size_t&amp; i : best_selection) {</span></a>
<a name="195"><span class="lineNum">     195 </span>  [<span class="branchCov" title="Branch 0 was taken 27760 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 27760 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      27760 :         result.AddInput(utxo_pool.at(i));</span></a>
<a name="196"><span class="lineNum">     196 </span>                :            :     }</a>
<a name="197"><span class="lineNum">     197 </span>                :<span class="lineCov">        134 :     result.ComputeAndSetWaste(cost_of_change, cost_of_change, CAmount{0});</span></a>
<a name="198"><span class="lineNum">     198 </span>  [<span class="branchCov" title="Branch 0 was taken 134 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 134 times"> + </span>]:<span class="lineCov">        134 :     assert(best_waste == result.GetWaste());</span></a>
<a name="199"><span class="lineNum">     199 </span>                :            : </a>
<a name="200"><span class="lineNum">     200 </span>                :<span class="lineCov">       7696 :     return result;</span></a>
<a name="201"><span class="lineNum">     201 </span>                :<span class="lineCov">       7951 : }</span></a>
<a name="202"><span class="lineNum">     202 </span>                :            : </a>
<a name="203"><span class="lineNum">     203 </span>                :            : /*</a>
<a name="204"><span class="lineNum">     204 </span>                :            :  * TL;DR: Coin Grinder is a DFS-based algorithm that deterministically searches for the minimum-weight input set to fund</a>
<a name="205"><span class="lineNum">     205 </span>                :            :  * the transaction. The algorithm is similar to the Branch and Bound algorithm, but will produce a transaction _with_ a</a>
<a name="206"><span class="lineNum">     206 </span>                :            :  * change output instead of a changeless transaction.</a>
<a name="207"><span class="lineNum">     207 </span>                :            :  *</a>
<a name="208"><span class="lineNum">     208 </span>                :            :  * Full description: CoinGrinder can be thought of as a graph walking algorithm. It explores a binary tree</a>
<a name="209"><span class="lineNum">     209 </span>                :            :  * representation of the powerset of the UTXO pool. Each node in the tree represents a candidate input set. The tree’s</a>
<a name="210"><span class="lineNum">     210 </span>                :            :  * root is the empty set. Each node in the tree has two children which are formed by either adding or skipping the next</a>
<a name="211"><span class="lineNum">     211 </span>                :            :  * UTXO (&quot;inclusion/omission branch&quot;). Each level in the tree after the root corresponds to a decision about one UTXO in</a>
<a name="212"><span class="lineNum">     212 </span>                :            :  * the UTXO pool.</a>
<a name="213"><span class="lineNum">     213 </span>                :            :  *</a>
<a name="214"><span class="lineNum">     214 </span>                :            :  * Example:</a>
<a name="215"><span class="lineNum">     215 </span>                :            :  * We represent UTXOs as _alias=[effective_value/weight]_ and indicate omitted UTXOs with an underscore. Given a UTXO</a>
<a name="216"><span class="lineNum">     216 </span>                :            :  * pool {A=[10/2], B=[7/1], C=[5/1], D=[4/2]} sorted by descending effective value, our search tree looks as follows:</a>
<a name="217"><span class="lineNum">     217 </span>                :            :  *</a>
<a name="218"><span class="lineNum">     218 </span>                :            :  *                                       _______________________ {} ________________________</a>
<a name="219"><span class="lineNum">     219 </span>                :            :  *                                      /                                                   \</a>
<a name="220"><span class="lineNum">     220 </span>                :            :  * A=[10/2]               __________ {A} _________                                __________ {_} _________</a>
<a name="221"><span class="lineNum">     221 </span>                :            :  *                       /                        \                              /                        \</a>
<a name="222"><span class="lineNum">     222 </span>                :            :  * B=[7/1]            {AB} _                      {A_} _                      {_B} _                      {__} _</a>
<a name="223"><span class="lineNum">     223 </span>                :            :  *                  /       \                   /       \                   /       \                   /       \</a>
<a name="224"><span class="lineNum">     224 </span>                :            :  * C=[5/1]     {ABC}         {AB_}         {A_C}         {A__}         {_BC}         {_B_}         {__C}         {___}</a>
<a name="225"><span class="lineNum">     225 </span>                :            :  *              / \           / \           / \           / \           / \           / \           / \           / \</a>
<a name="226"><span class="lineNum">     226 </span>                :            :  * D=[4/2] {ABCD} {ABC_} {AB_D} {AB__} {A_CD} {A_C_} {A__D} {A___} {_BCD} {_BC_} {_B_D} {_B__} {__CD} {__C_} {___D} {____}</a>
<a name="227"><span class="lineNum">     227 </span>                :            :  *</a>
<a name="228"><span class="lineNum">     228 </span>                :            :  *</a>
<a name="229"><span class="lineNum">     229 </span>                :            :  * CoinGrinder uses a depth-first search to walk this tree. It first tries inclusion branches, then omission branches. A</a>
<a name="230"><span class="lineNum">     230 </span>                :            :  * naive exploration of a tree with four UTXOs requires visiting all 31 nodes:</a>
<a name="231"><span class="lineNum">     231 </span>                :            :  *</a>
<a name="232"><span class="lineNum">     232 </span>                :            :  *     {} {A} {AB} {ABC} {ABCD} {ABC_} {AB_} {AB_D} {AB__} {A_} {A_C} {A_CD} {A_C_} {A__} {A__D} {A___} {_} {_B} {_BC}</a>
<a name="233"><span class="lineNum">     233 </span>                :            :  *     {_BCD} {_BC_} {_B_} {_B_D} {_B__} {__} {__C} {__CD} {__C} {___} {___D} {____}</a>
<a name="234"><span class="lineNum">     234 </span>                :            :  *</a>
<a name="235"><span class="lineNum">     235 </span>                :            :  * As powersets grow exponentially with the set size, walking the entire tree would quickly get computationally</a>
<a name="236"><span class="lineNum">     236 </span>                :            :  * infeasible with growing UTXO pools. Thanks to traversing the tree in a deterministic order, we can keep track of the</a>
<a name="237"><span class="lineNum">     237 </span>                :            :  * progress of the search solely on basis of the current selection (and the best selection so far). We visit as few</a>
<a name="238"><span class="lineNum">     238 </span>                :            :  * nodes as possible by recognizing and skipping any branches that can only contain solutions worse than the best</a>
<a name="239"><span class="lineNum">     239 </span>                :            :  * solution so far. This makes CoinGrinder a branch-and-bound algorithm</a>
<a name="240"><span class="lineNum">     240 </span>                :            :  * (https://en.wikipedia.org/wiki/Branch_and_bound).</a>
<a name="241"><span class="lineNum">     241 </span>                :            :  * CoinGrinder is searching for the input set with lowest weight that can fund a transaction, so for example we can only</a>
<a name="242"><span class="lineNum">     242 </span>                :            :  * ever find a _better_ candidate input set in a node that adds a UTXO, but never in a node that skips a UTXO. After</a>
<a name="243"><span class="lineNum">     243 </span>                :            :  * visiting {A} and exploring the inclusion branch {AB} and its descendants, the candidate input set in the omission</a>
<a name="244"><span class="lineNum">     244 </span>                :            :  * branch {A_} is equivalent to the parent {A} in effective value and weight. While CoinGrinder does need to visit the</a>
<a name="245"><span class="lineNum">     245 </span>                :            :  * descendants of the omission branch {A_}, it is unnecessary to evaluate the candidate input set in the omission branch</a>
<a name="246"><span class="lineNum">     246 </span>                :            :  * itself. By skipping evaluation of all nodes on an omission branch we reduce the visited nodes to 15:</a>
<a name="247"><span class="lineNum">     247 </span>                :            :  *</a>
<a name="248"><span class="lineNum">     248 </span>                :            :  *     {A} {AB} {ABC} {ABCD} {AB_D} {A_C} {A_CD} {A__D} {_B} {_BC} {_BCD} {_B_D} {__C} {__CD} {___D}</a>
<a name="249"><span class="lineNum">     249 </span>                :            :  *</a>
<a name="250"><span class="lineNum">     250 </span>                :            :  *                                       _______________________ {} ________________________</a>
<a name="251"><span class="lineNum">     251 </span>                :            :  *                                      /                                                   \</a>
<a name="252"><span class="lineNum">     252 </span>                :            :  * A=[10/2]               __________ {A} _________                                ___________\____________</a>
<a name="253"><span class="lineNum">     253 </span>                :            :  *                       /                        \                              /                        \</a>
<a name="254"><span class="lineNum">     254 </span>                :            :  * B=[7/1]            {AB} __                    __\_____                     {_B} __                    __\_____</a>
<a name="255"><span class="lineNum">     255 </span>                :            :  *                  /        \                  /        \                  /        \                  /        \</a>
<a name="256"><span class="lineNum">     256 </span>                :            :  * C=[5/1]     {ABC}          \            {A_C}          \            {_BC}          \            {__C}          \</a>
<a name="257"><span class="lineNum">     257 </span>                :            :  *              /             /             /             /             /             /             /             /</a>
<a name="258"><span class="lineNum">     258 </span>                :            :  * D=[4/2] {ABCD}        {AB_D}        {A_CD}        {A__D}        {_BCD}        {_B_D}        {__CD}        {___D}</a>
<a name="259"><span class="lineNum">     259 </span>                :            :  *</a>
<a name="260"><span class="lineNum">     260 </span>                :            :  *</a>
<a name="261"><span class="lineNum">     261 </span>                :            :  * We refer to the move from the inclusion branch {AB} via the omission branch {A_} to its inclusion-branch child {A_C}</a>
<a name="262"><span class="lineNum">     262 </span>                :            :  * as _shifting to the omission branch_ or just _SHIFT_. (The index of the ultimate element in the candidate input set</a>
<a name="263"><span class="lineNum">     263 </span>                :            :  * shifts right by one: {AB} ⇒ {A_C}.)</a>
<a name="264"><span class="lineNum">     264 </span>                :            :  * When we reach a leaf node in the last level of the tree, shifting to the omission branch is not possible. Instead we</a>
<a name="265"><span class="lineNum">     265 </span>                :            :  * go to the omission branch of the node’s last ancestor on an inclusion branch: from {ABCD}, we go to {AB_D}. From</a>
<a name="266"><span class="lineNum">     266 </span>                :            :  * {AB_D}, we go to {A_C}. We refer to this operation as a _CUT_. (The ultimate element in</a>
<a name="267"><span class="lineNum">     267 </span>                :            :  * the input set is deselected, and the penultimate element is shifted right by one: {AB_D} ⇒ {A_C}.)</a>
<a name="268"><span class="lineNum">     268 </span>                :            :  * If a candidate input set in a node has not selected sufficient funds to build the transaction, we continue directly</a>
<a name="269"><span class="lineNum">     269 </span>                :            :  * along the next inclusion branch. We call this operation _EXPLORE_. (We go from one inclusion branch to the next</a>
<a name="270"><span class="lineNum">     270 </span>                :            :  * inclusion branch: {_B} ⇒ {_BC}.)</a>
<a name="271"><span class="lineNum">     271 </span>                :            :  * Further, any prefix that already has selected sufficient effective value to fund the transaction cannot be improved</a>
<a name="272"><span class="lineNum">     272 </span>                :            :  * by adding more UTXOs. If for example the candidate input set in {AB} is a valid solution, all potential descendant</a>
<a name="273"><span class="lineNum">     273 </span>                :            :  * solutions {ABC}, {ABCD}, and {AB_D} must have a higher weight, thus instead of exploring the descendants of {AB}, we</a>
<a name="274"><span class="lineNum">     274 </span>                :            :  * can SHIFT from {AB} to {A_C}.</a>
<a name="275"><span class="lineNum">     275 </span>                :            :  *</a>
<a name="276"><span class="lineNum">     276 </span>                :            :  * Given the above UTXO set, using a target of 11, and following these initial observations, the basic implementation of</a>
<a name="277"><span class="lineNum">     277 </span>                :            :  * CoinGrinder visits the following 10 nodes:</a>
<a name="278"><span class="lineNum">     278 </span>                :            :  *</a>
<a name="279"><span class="lineNum">     279 </span>                :            :  *     Node   [eff_val/weight]  Evaluation</a>
<a name="280"><span class="lineNum">     280 </span>                :            :  *     ---------------------------------------------------------------</a>
<a name="281"><span class="lineNum">     281 </span>                :            :  *     {A}    [10/2]            Insufficient funds: EXPLORE</a>
<a name="282"><span class="lineNum">     282 </span>                :            :  *     {AB}   [17/3]            Solution: SHIFT to omission branch</a>
<a name="283"><span class="lineNum">     283 </span>                :            :  *     {A_C}  [15/3]            Better solution: SHIFT to omission branch</a>
<a name="284"><span class="lineNum">     284 </span>                :            :  *     {A__D} [14/4]            Worse solution, shift impossible due to leaf node: CUT to omission branch of {A__D},</a>
<a name="285"><span class="lineNum">     285 </span>                :            :  *                              i.e. SHIFT to omission branch of {A}</a>
<a name="286"><span class="lineNum">     286 </span>                :            :  *     {_B}   [7/1]             Insufficient funds: EXPLORE</a>
<a name="287"><span class="lineNum">     287 </span>                :            :  *     {_BC}  [12/2]            Better solution: SHIFT to omission branch</a>
<a name="288"><span class="lineNum">     288 </span>                :            :  *     {_B_D} [11/3]            Worse solution, shift impossible due to leaf node: CUT to omission branch of {_B_D},</a>
<a name="289"><span class="lineNum">     289 </span>                :            :  *                              i.e. SHIFT to omission branch of {_B}</a>
<a name="290"><span class="lineNum">     290 </span>                :            :  *     {__C}  [5/1]             Insufficient funds: EXPLORE</a>
<a name="291"><span class="lineNum">     291 </span>                :            :  *     {__CD} [9/3]             Insufficient funds, leaf node: CUT</a>
<a name="292"><span class="lineNum">     292 </span>                :            :  *     {___D} [4/2]             Insufficient funds, leaf node, cannot CUT since only one UTXO selected: done.</a>
<a name="293"><span class="lineNum">     293 </span>                :            :  *</a>
<a name="294"><span class="lineNum">     294 </span>                :            :  *                                       _______________________ {} ________________________</a>
<a name="295"><span class="lineNum">     295 </span>                :            :  *                                      /                                                   \</a>
<a name="296"><span class="lineNum">     296 </span>                :            :  * A=[10/2]               __________ {A} _________                                ___________\____________</a>
<a name="297"><span class="lineNum">     297 </span>                :            :  *                       /                        \                              /                        \</a>
<a name="298"><span class="lineNum">     298 </span>                :            :  * B=[7/1]            {AB}                       __\_____                     {_B} __                    __\_____</a>
<a name="299"><span class="lineNum">     299 </span>                :            :  *                                              /        \                  /        \                  /        \</a>
<a name="300"><span class="lineNum">     300 </span>                :            :  * C=[5/1]                                 {A_C}          \            {_BC}          \            {__C}          \</a>
<a name="301"><span class="lineNum">     301 </span>                :            :  *                                                        /                           /             /             /</a>
<a name="302"><span class="lineNum">     302 </span>                :            :  * D=[4/2]                                           {A__D}                      {_B_D}        {__CD}        {___D}</a>
<a name="303"><span class="lineNum">     303 </span>                :            :  *</a>
<a name="304"><span class="lineNum">     304 </span>                :            :  *</a>
<a name="305"><span class="lineNum">     305 </span>                :            :  * We implement this tree walk in the following algorithm:</a>
<a name="306"><span class="lineNum">     306 </span>                :            :  * 1. Add `next_utxo`</a>
<a name="307"><span class="lineNum">     307 </span>                :            :  * 2. Evaluate candidate input set</a>
<a name="308"><span class="lineNum">     308 </span>                :            :  * 3. Determine `next_utxo` by deciding whether to</a>
<a name="309"><span class="lineNum">     309 </span>                :            :  *    a) EXPLORE: Add next inclusion branch, e.g. {_B} ⇒ {_B} + `next_uxto`: C</a>
<a name="310"><span class="lineNum">     310 </span>                :            :  *    b) SHIFT: Replace last selected UTXO by next higher index, e.g. {A_C} ⇒ {A__} + `next_utxo`: D</a>
<a name="311"><span class="lineNum">     311 </span>                :            :  *    c) CUT: deselect last selected UTXO and shift to omission branch of penultimate UTXO, e.g. {AB_D} ⇒ {A_} + `next_utxo: C</a>
<a name="312"><span class="lineNum">     312 </span>                :            :  *</a>
<a name="313"><span class="lineNum">     313 </span>                :            :  * The implementation then adds further optimizations by discovering further situations in which either the inclusion</a>
<a name="314"><span class="lineNum">     314 </span>                :            :  * branch can be skipped, or both the inclusion and omission branch can be skipped after evaluating the candidate input</a>
<a name="315"><span class="lineNum">     315 </span>                :            :  * set in the node.</a>
<a name="316"><span class="lineNum">     316 </span>                :            :  *</a>
<a name="317"><span class="lineNum">     317 </span>                :            :  * @param std::vector&lt;OutputGroup&gt;&amp; utxo_pool The UTXOs that we are choosing from. These UTXOs will be sorted in</a>
<a name="318"><span class="lineNum">     318 </span>                :            :  *        descending order by effective value, with lower weight preferred as a tie-breaker. (We can think of an output</a>
<a name="319"><span class="lineNum">     319 </span>                :            :  *        group with multiple as a heavier UTXO with the combined amount here.)</a>
<a name="320"><span class="lineNum">     320 </span>                :            :  * @param const CAmount&amp; selection_target This is the minimum amount that we need for the transaction without considering change.</a>
<a name="321"><span class="lineNum">     321 </span>                :            :  * @param const CAmount&amp; change_target The minimum budget for creating a change output, by which we increase the selection_target.</a>
<a name="322"><span class="lineNum">     322 </span>                :            :  * @param int max_weight The maximum permitted weight for the input set.</a>
<a name="323"><span class="lineNum">     323 </span>                :            :  * @returns The result of this coin selection algorithm, or std::nullopt</a>
<a name="324"><span class="lineNum">     324 </span>                :            :  */</a>
<a name="325"><span class="lineNum">     325 </span>                :<span class="lineCov">        897 : util::Result&lt;SelectionResult&gt; CoinGrinder(std::vector&lt;OutputGroup&gt;&amp; utxo_pool, const CAmount&amp; selection_target, CAmount change_target, int max_weight)</span></a>
<a name="326"><span class="lineNum">     326 </span>                :            : {</a>
<a name="327"><span class="lineNum">     327 </span>                :<span class="lineCov">        897 :     std::sort(utxo_pool.begin(), utxo_pool.end(), descending_effval_weight);</span></a>
<a name="328"><span class="lineNum">     328 </span>                :            :     // The sum of UTXO amounts after this UTXO index, e.g. lookahead[5] = Σ(UTXO[6+].amount)</a>
<a name="329"><span class="lineNum">     329 </span>                :<span class="lineCov">        897 :     std::vector&lt;CAmount&gt; lookahead(utxo_pool.size());</span></a>
<a name="330"><span class="lineNum">     330 </span>                :            :     // The minimum UTXO weight among the remaining UTXOs after this UTXO index, e.g. min_tail_weight[5] = min(UTXO[6+].weight)</a>
<a name="331"><span class="lineNum">     331 </span>        [<span class="branchCov" title="Branch 0 was taken 897 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        897 :     std::vector&lt;int&gt; min_tail_weight(utxo_pool.size());</span></a>
<a name="332"><span class="lineNum">     332 </span>                :            : </a>
<a name="333"><span class="lineNum">     333 </span>                :            :     // Calculate lookahead values, min_tail_weights, and check that there are sufficient funds</a>
<a name="334"><span class="lineNum">     334 </span>                :<span class="lineCov">        897 :     CAmount total_available = 0;</span></a>
<a name="335"><span class="lineNum">     335 </span>                :<span class="lineCov">        897 :     int min_group_weight = std::numeric_limits&lt;int&gt;::max();</span></a>
<a name="336"><span class="lineNum">     336 </span>        [<span class="branchCov" title="Branch 0 was taken 9921 times"> + </span><span class="branchCov" title="Branch 1 was taken 897 times"> + </span>]:<span class="lineCov">      10818 :     for (size_t i = 0; i &lt; utxo_pool.size(); ++i) {</span></a>
<a name="337"><span class="lineNum">     337 </span>                :<span class="lineCov">       9921 :         size_t index = utxo_pool.size() - 1 - i; // Loop over every element in reverse order</span></a>
<a name="338"><span class="lineNum">     338 </span>        [<span class="branchCov" title="Branch 0 was taken 912 times"> + </span><span class="branchCov" title="Branch 1 was taken 9009 times"> + </span>]:<span class="lineCov">       9921 :         lookahead[index] = total_available;</span></a>
<a name="339"><span class="lineNum">     339 </span>                :<span class="lineCov">       9921 :         min_tail_weight[index] = min_group_weight;</span></a>
<a name="340"><span class="lineNum">     340 </span>                :            :         // UTXOs with non-positive effective value must have been filtered</a>
<a name="341"><span class="lineNum">     341 </span>                :<span class="lineCov">       9921 :         Assume(utxo_pool[index].GetSelectionAmount() &gt; 0);</span></a>
<a name="342"><span class="lineNum">     342 </span>                :<span class="lineCov">       9921 :         total_available += utxo_pool[index].GetSelectionAmount();</span></a>
<a name="343"><span class="lineNum">     343 </span>        [<span class="branchCov" title="Branch 0 was taken 912 times"> + </span><span class="branchCov" title="Branch 1 was taken 9009 times"> + </span>]:<span class="lineCov">      10833 :         min_group_weight = std::min(min_group_weight, utxo_pool[index].m_weight);</span></a>
<a name="344"><span class="lineNum">     344 </span>                :            :     }</a>
<a name="345"><span class="lineNum">     345 </span>                :            : </a>
<a name="346"><span class="lineNum">     346 </span>                :<span class="lineCov">        897 :     const CAmount total_target = selection_target + change_target;</span></a>
<a name="347"><span class="lineNum">     347 </span>        [<span class="branchCov" title="Branch 0 was taken 335 times"> + </span><span class="branchCov" title="Branch 1 was taken 562 times"> + </span>]:<span class="lineCov">        897 :     if (total_available &lt; total_target) {</span></a>
<a name="348"><span class="lineNum">     348 </span>                :            :         // Insufficient funds</a>
<a name="349"><span class="lineNum">     349 </span>                :<span class="lineCov">        335 :         return util::Error();</span></a>
<a name="350"><span class="lineNum">     350 </span>                :            :     }</a>
<a name="351"><span class="lineNum">     351 </span>                :            : </a>
<a name="352"><span class="lineNum">     352 </span>                :            :     // The current selection and the best input set found so far, stored as the utxo_pool indices of the UTXOs forming them</a>
<a name="353"><span class="lineNum">     353 </span>                :<span class="lineCov">        562 :     std::vector&lt;size_t&gt; curr_selection;</span></a>
<a name="354"><span class="lineNum">     354 </span>                :<span class="lineCov">        562 :     std::vector&lt;size_t&gt; best_selection;</span></a>
<a name="355"><span class="lineNum">     355 </span>                :            : </a>
<a name="356"><span class="lineNum">     356 </span>                :            :     // The currently selected effective amount, and the effective amount of the best selection so far</a>
<a name="357"><span class="lineNum">     357 </span>                :<span class="lineCov">        562 :     CAmount curr_amount = 0;</span></a>
<a name="358"><span class="lineNum">     358 </span>                :<span class="lineCov">        562 :     CAmount best_selection_amount = MAX_MONEY;</span></a>
<a name="359"><span class="lineNum">     359 </span>                :            : </a>
<a name="360"><span class="lineNum">     360 </span>                :            :     // The weight of the currently selected input set, and the weight of the best selection</a>
<a name="361"><span class="lineNum">     361 </span>                :<span class="lineCov">        562 :     int curr_weight = 0;</span></a>
<a name="362"><span class="lineNum">     362 </span>                :<span class="lineCov">        562 :     int best_selection_weight = max_weight; // Tie is fine, because we prefer lower selection amount</span></a>
<a name="363"><span class="lineNum">     363 </span>                :            : </a>
<a name="364"><span class="lineNum">     364 </span>                :            :     // Whether the input sets generated during this search have exceeded the maximum transaction weight at any point</a>
<a name="365"><span class="lineNum">     365 </span>                :<span class="lineCov">        562 :     bool max_tx_weight_exceeded = false;</span></a>
<a name="366"><span class="lineNum">     366 </span>                :            : </a>
<a name="367"><span class="lineNum">     367 </span>                :            :     // Index of the next UTXO to consider in utxo_pool</a>
<a name="368"><span class="lineNum">     368 </span>                :<span class="lineCov">        562 :     size_t next_utxo = 0;</span></a>
<a name="369"><span class="lineNum">     369 </span>                :            : </a>
<a name="370"><span class="lineNum">     370 </span>                :            :     /*</a>
<a name="371"><span class="lineNum">     371 </span>                :            :      * You can think of the current selection as a vector of booleans that has decided inclusion or exclusion of all</a>
<a name="372"><span class="lineNum">     372 </span>                :            :      * UTXOs before `next_utxo`. When we consider the next UTXO, we extend this hypothetical boolean vector either with</a>
<a name="373"><span class="lineNum">     373 </span>                :            :      * a true value if the UTXO is included or a false value if it is omitted. The equivalent state is stored more</a>
<a name="374"><span class="lineNum">     374 </span>                :            :      * compactly as the list of indices of the included UTXOs and the `next_utxo` index.</a>
<a name="375"><span class="lineNum">     375 </span>                :            :      *</a>
<a name="376"><span class="lineNum">     376 </span>                :            :      * We can never find a new solution by deselecting a UTXO, because we then revisit a previously evaluated</a>
<a name="377"><span class="lineNum">     377 </span>                :            :      * selection. Therefore, we only need to check whether we found a new solution _after adding_ a new UTXO.</a>
<a name="378"><span class="lineNum">     378 </span>                :            :      *</a>
<a name="379"><span class="lineNum">     379 </span>                :            :      * Each iteration of CoinGrinder starts by selecting the `next_utxo` and evaluating the current selection. We</a>
<a name="380"><span class="lineNum">     380 </span>                :            :      * use three state transitions to progress from the current selection to the next promising selection:</a>
<a name="381"><span class="lineNum">     381 </span>                :            :      *</a>
<a name="382"><span class="lineNum">     382 </span>                :            :      * - EXPLORE inclusion branch: We do not have sufficient funds, yet. Add `next_utxo` to the current selection, then</a>
<a name="383"><span class="lineNum">     383 </span>                :            :      *                             nominate the direct successor of the just selected UTXO as our `next_utxo` for the</a>
<a name="384"><span class="lineNum">     384 </span>                :            :      *                             following iteration.</a>
<a name="385"><span class="lineNum">     385 </span>                :            :      *</a>
<a name="386"><span class="lineNum">     386 </span>                :            :      *                             Example:</a>
<a name="387"><span class="lineNum">     387 </span>                :            :      *                                 Current Selection: {0, 5, 7}</a>
<a name="388"><span class="lineNum">     388 </span>                :            :      *                                 Evaluation: EXPLORE, next_utxo: 8</a>
<a name="389"><span class="lineNum">     389 </span>                :            :      *                                 Next Selection: {0, 5, 7, 8}</a>
<a name="390"><span class="lineNum">     390 </span>                :            :      *</a>
<a name="391"><span class="lineNum">     391 </span>                :            :      * - SHIFT to omission branch: Adding more UTXOs to the current selection cannot produce a solution that is better</a>
<a name="392"><span class="lineNum">     392 </span>                :            :      *                             than the current best, e.g. the current selection weight exceeds the max weight or</a>
<a name="393"><span class="lineNum">     393 </span>                :            :      *                             the current selection amount is equal to or greater than the target.</a>
<a name="394"><span class="lineNum">     394 </span>                :            :      *                             We designate our `next_utxo` the one after the tail of our current selection, then</a>
<a name="395"><span class="lineNum">     395 </span>                :            :      *                             deselect the tail of our current selection.</a>
<a name="396"><span class="lineNum">     396 </span>                :            :      *</a>
<a name="397"><span class="lineNum">     397 </span>                :            :      *                             Example:</a>
<a name="398"><span class="lineNum">     398 </span>                :            :      *                                 Current Selection: {0, 5, 7}</a>
<a name="399"><span class="lineNum">     399 </span>                :            :      *                                 Evaluation: SHIFT, next_utxo: 8, omit last selected: {0, 5}</a>
<a name="400"><span class="lineNum">     400 </span>                :            :      *                                 Next Selection: {0, 5, 8}</a>
<a name="401"><span class="lineNum">     401 </span>                :            :      *</a>
<a name="402"><span class="lineNum">     402 </span>                :            :      * - CUT entire subtree:       We have exhausted the inclusion branch for the penultimately selected UTXO, both the</a>
<a name="403"><span class="lineNum">     403 </span>                :            :      *                             inclusion and the omission branch of the current prefix are barren. E.g. we have</a>
<a name="404"><span class="lineNum">     404 </span>                :            :      *                             reached the end of the UTXO pool, so neither further EXPLORING nor SHIFTING can find</a>
<a name="405"><span class="lineNum">     405 </span>                :            :      *                             any solutions. We designate our `next_utxo` the one after our penultimate selected,</a>
<a name="406"><span class="lineNum">     406 </span>                :            :      *                             then deselect both the last and penultimate selected.</a>
<a name="407"><span class="lineNum">     407 </span>                :            :      *</a>
<a name="408"><span class="lineNum">     408 </span>                :            :      *                             Example:</a>
<a name="409"><span class="lineNum">     409 </span>                :            :      *                                 Current Selection: {0, 5, 7}</a>
<a name="410"><span class="lineNum">     410 </span>                :            :      *                                 Evaluation: CUT, next_utxo: 6, omit two last selected: {0}</a>
<a name="411"><span class="lineNum">     411 </span>                :            :      *                                 Next Selection: {0, 6}</a>
<a name="412"><span class="lineNum">     412 </span>                :            :      */</a>
<a name="413"><span class="lineNum">     413 </span>                :<span class="lineCov">     979460 :     auto deselect_last = [&amp;]() {</span></a>
<a name="414"><span class="lineNum">     414 </span>                :<span class="lineCov">     978898 :         OutputGroup&amp; utxo = utxo_pool[curr_selection.back()];</span></a>
<a name="415"><span class="lineNum">     415 </span>                :<span class="lineCov">     978898 :         curr_amount -= utxo.GetSelectionAmount();</span></a>
<a name="416"><span class="lineNum">     416 </span>                :<span class="lineCov">     978898 :         curr_weight -= utxo.m_weight;</span></a>
<a name="417"><span class="lineNum">     417 </span>                :<span class="lineCov">     978898 :         curr_selection.pop_back();</span></a>
<a name="418"><span class="lineNum">     418 </span>                :<span class="lineCov">     979460 :     };</span></a>
<a name="419"><span class="lineNum">     419 </span>                :            : </a>
<a name="420"><span class="lineNum">     420 </span>                :<span class="lineCov">        562 :     SelectionResult result(selection_target, SelectionAlgorithm::CG);</span></a>
<a name="421"><span class="lineNum">     421 </span>                :<span class="lineCov">        562 :     bool is_done = false;</span></a>
<a name="422"><span class="lineNum">     422 </span>                :<span class="lineCov">        562 :     size_t curr_try = 0;</span></a>
<a name="423"><span class="lineNum">     423 </span>        [<span class="branchCov" title="Branch 0 was taken 979036 times"> + </span><span class="branchCov" title="Branch 1 was taken 554 times"> + </span>]:<span class="lineCov">     979590 :     while (!is_done) {</span></a>
<a name="424"><span class="lineNum">     424 </span>                :<span class="lineCov">     979036 :         bool should_shift{false}, should_cut{false};</span></a>
<a name="425"><span class="lineNum">     425 </span>                :            :         // Select `next_utxo`</a>
<a name="426"><span class="lineNum">     426 </span>        [<span class="branchCov" title="Branch 0 was taken 979036 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     979036 :         OutputGroup&amp; utxo = utxo_pool[next_utxo];</span></a>
<a name="427"><span class="lineNum">     427 </span>                :<span class="lineCov">     979036 :         curr_amount += utxo.GetSelectionAmount();</span></a>
<a name="428"><span class="lineNum">     428 </span>                :<span class="lineCov">     979036 :         curr_weight += utxo.m_weight;</span></a>
<a name="429"><span class="lineNum">     429 </span>        [<span class="branchCov" title="Branch 0 was taken 979036 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     979036 :         curr_selection.push_back(next_utxo);</span></a>
<a name="430"><span class="lineNum">     430 </span>                :<span class="lineCov">     979036 :         ++next_utxo;</span></a>
<a name="431"><span class="lineNum">     431 </span>                :<span class="lineCov">     979036 :         ++curr_try;</span></a>
<a name="432"><span class="lineNum">     432 </span>                :            : </a>
<a name="433"><span class="lineNum">     433 </span>                :            :         // EVALUATE current selection: check for solutions and see whether we can CUT or SHIFT before EXPLORING further</a>
<a name="434"><span class="lineNum">     434 </span>                :<span class="lineCov">     979036 :         auto curr_tail = curr_selection.back();</span></a>
<a name="435"><span class="lineNum">     435 </span>        [<span class="branchCov" title="Branch 0 was taken 852023 times"> + </span><span class="branchCov" title="Branch 1 was taken 127013 times"> + </span>]:<span class="lineCov">     979036 :         if (curr_amount + lookahead[curr_tail] &lt; total_target) {</span></a>
<a name="436"><span class="lineNum">     436 </span>                :            :             // Insufficient funds with lookahead: CUT</a>
<a name="437"><span class="lineNum">     437 </span>                :            :             should_cut = true;</a>
<a name="438"><span class="lineNum">     438 </span>        [<span class="branchCov" title="Branch 0 was taken 47079 times"> + </span><span class="branchCov" title="Branch 1 was taken 804944 times"> + </span>]:<span class="lineCov">     852023 :         } else if (curr_weight &gt; best_selection_weight) {</span></a>
<a name="439"><span class="lineNum">     439 </span>                :            :             // best_selection_weight is initialized to max_weight</a>
<a name="440"><span class="lineNum">     440 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 47078 times"> + </span>]:<span class="lineCov">      47079 :             if (curr_weight &gt; max_weight) max_tx_weight_exceeded = true;</span></a>
<a name="441"><span class="lineNum">     441 </span>                :            :             // Worse weight than best solution. More UTXOs only increase weight:</a>
<a name="442"><span class="lineNum">     442 </span>                :            :             // CUT if last selected group had minimal weight, else SHIFT</a>
<a name="443"><span class="lineNum">     443 </span>        [<span class="branchCov" title="Branch 0 was taken 47063 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">      47079 :             if (utxo_pool[curr_tail].m_weight &lt;= min_tail_weight[curr_tail]) {</span></a>
<a name="444"><span class="lineNum">     444 </span>                :            :                 should_cut = true;</a>
<a name="445"><span class="lineNum">     445 </span>                :            :             } else {</a>
<a name="446"><span class="lineNum">     446 </span>                :<span class="lineCov">      47063 :                 should_shift  = true;</span></a>
<a name="447"><span class="lineNum">     447 </span>                :            :             }</a>
<a name="448"><span class="lineNum">     448 </span>        [<span class="branchCov" title="Branch 0 was taken 424291 times"> + </span><span class="branchCov" title="Branch 1 was taken 380653 times"> + </span>]:<span class="lineCov">     804944 :         } else if (curr_amount &gt;= total_target) {</span></a>
<a name="449"><span class="lineNum">     449 </span>                :            :             // Success, adding more weight cannot be better: SHIFT</a>
<a name="450"><span class="lineNum">     450 </span>                :<span class="lineCov">     424291 :             should_shift  = true;</span></a>
<a name="451"><span class="lineNum">     451 </span>  [<span class="branchCov" title="Branch 0 was taken 423705 times"> + </span><span class="branchCov" title="Branch 1 was taken 586 times"> + </span><span class="branchCov" title="Branch 2 was taken 423705 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">     424291 :             if (curr_weight &lt; best_selection_weight || (curr_weight == best_selection_weight &amp;&amp; curr_amount &lt; best_selection_amount)) {</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 10705 times"> + </span><span class="branchCov" title="Branch 5 was taken 413000 times"> + </span>]
<a name="452"><span class="lineNum">     452 </span>                :            :                 // New lowest weight, or same weight with fewer funds tied up</a>
<a name="453"><span class="lineNum">     453 </span>        [<span class="branchCov" title="Branch 0 was taken 11291 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      11291 :                 best_selection = curr_selection;</span></a>
<a name="454"><span class="lineNum">     454 </span>                :<span class="lineCov">      11291 :                 best_selection_weight = curr_weight;</span></a>
<a name="455"><span class="lineNum">     455 </span>                :<span class="lineCov">      11291 :                 best_selection_amount = curr_amount;</span></a>
<a name="456"><span class="lineNum">     456 </span>                :            :             }</a>
<a name="457"><span class="lineNum">     457 </span>  [<span class="branchCov" title="Branch 0 was taken 380044 times"> + </span><span class="branchCov" title="Branch 1 was taken 609 times"> + </span><span class="branchCov" title="Branch 2 was taken 48310 times"> + </span><span class="branchCov" title="Branch 3 was taken 331734 times"> + </span>]:<span class="lineCov">     380653 :         } else if (!best_selection.empty() &amp;&amp; curr_weight + int64_t{min_tail_weight[curr_tail]} * ((total_target - curr_amount + utxo_pool[curr_tail].GetSelectionAmount() - 1) / utxo_pool[curr_tail].GetSelectionAmount()) &gt; best_selection_weight) {</span></a>
<a name="458"><span class="lineNum">     458 </span>                :            :             // Compare minimal tail weight and last selected amount with the amount missing to gauge whether a better weight is still possible.</a>
<a name="459"><span class="lineNum">     459 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 48301 times"> + </span>]:<span class="lineCov">      48310 :             if (utxo_pool[curr_tail].m_weight &lt;= min_tail_weight[curr_tail]) {</span></a>
<a name="460"><span class="lineNum">     460 </span>                :            :                 should_cut = true;</a>
<a name="461"><span class="lineNum">     461 </span>                :            :             } else {</a>
<a name="462"><span class="lineNum">     462 </span>                :<span class="lineCov">          9 :                 should_shift = true;</span></a>
<a name="463"><span class="lineNum">     463 </span>                :            :             }</a>
<a name="464"><span class="lineNum">     464 </span>                :            :         }</a>
<a name="465"><span class="lineNum">     465 </span>                :            : </a>
<a name="466"><span class="lineNum">     466 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 979028 times"> + </span>]:<span class="lineCov">     979036 :         if (curr_try &gt;= TOTAL_TRIES) {</span></a>
<a name="467"><span class="lineNum">     467 </span>                :            :             // Solution is not guaranteed to be optimal if `curr_try` hit TOTAL_TRIES</a>
<a name="468"><span class="lineNum">     468 </span>                :<span class="lineCov">          8 :             result.SetAlgoCompleted(false);</span></a>
<a name="469"><span class="lineNum">     469 </span>                :<span class="lineCov">          8 :             break;</span></a>
<a name="470"><span class="lineNum">     470 </span>                :            :         }</a>
<a name="471"><span class="lineNum">     471 </span>                :            : </a>
<a name="472"><span class="lineNum">     472 </span>        [<span class="branchCov" title="Branch 0 was taken 753232 times"> + </span><span class="branchCov" title="Branch 1 was taken 225796 times"> + </span>]:<span class="lineCov">     979028 :         if (next_utxo == utxo_pool.size()) {</span></a>
<a name="473"><span class="lineNum">     473 </span>                :            :             // Last added UTXO was end of UTXO pool, nothing left to add on inclusion or omission branch: CUT</a>
<a name="474"><span class="lineNum">     474 </span>                :            :             should_cut = true;</a>
<a name="475"><span class="lineNum">     475 </span>                :            :         }</a>
<a name="476"><span class="lineNum">     476 </span>                :            : </a>
<a name="477"><span class="lineNum">     477 </span>        [<span class="branchCov" title="Branch 0 was taken 106814 times"> + </span><span class="branchCov" title="Branch 1 was taken 646418 times"> + </span>]:<span class="lineCov">     753232 :         if (should_cut) {</span></a>
<a name="478"><span class="lineNum">     478 </span>                :            :             // Neither adding to the current selection nor exploring the omission branch of the last selected UTXO can</a>
<a name="479"><span class="lineNum">     479 </span>                :            :             // find any solutions. Redirect to exploring the Omission branch of the penultimate selected UTXO (i.e.</a>
<a name="480"><span class="lineNum">     480 </span>                :            :             // set `next_utxo` to one after the penultimate selected, then deselect the last two selected UTXOs)</a>
<a name="481"><span class="lineNum">     481 </span>                :<span class="lineCov">     332610 :             should_cut = false;</span></a>
<a name="482"><span class="lineNum">     482 </span>                :<span class="lineCov">     332610 :             deselect_last();</span></a>
<a name="483"><span class="lineNum">     483 </span>                :<span class="lineCov">     332610 :             should_shift  = true;</span></a>
<a name="484"><span class="lineNum">     484 </span>                :            :         }</a>
<a name="485"><span class="lineNum">     485 </span>                :            : </a>
<a name="486"><span class="lineNum">     486 </span>        [<span class="branchCov" title="Branch 0 was taken 646842 times"> + </span><span class="branchCov" title="Branch 1 was taken 978474 times"> + </span>]:<span class="lineCov">    1625316 :         while (should_shift) {</span></a>
<a name="487"><span class="lineNum">     487 </span>                :            :             // Set `next_utxo` to one after last selected, then deselect last selected UTXO</a>
<a name="488"><span class="lineNum">     488 </span>        [<span class="branchCov" title="Branch 0 was taken 554 times"> + </span><span class="branchCov" title="Branch 1 was taken 646288 times"> + </span>]:<span class="lineCov">     646842 :             if (curr_selection.empty()) {</span></a>
<a name="489"><span class="lineNum">     489 </span>                :            :                 // Exhausted search space before running into attempt limit</a>
<a name="490"><span class="lineNum">     490 </span>                :<span class="lineCov">        554 :                 is_done = true;</span></a>
<a name="491"><span class="lineNum">     491 </span>                :<span class="lineCov">        554 :                 result.SetAlgoCompleted(true);</span></a>
<a name="492"><span class="lineNum">     492 </span>                :<span class="lineCov">        554 :                 break;</span></a>
<a name="493"><span class="lineNum">     493 </span>                :            :             }</a>
<a name="494"><span class="lineNum">     494 </span>                :<span class="lineCov">     646288 :             next_utxo = curr_selection.back() + 1;</span></a>
<a name="495"><span class="lineNum">     495 </span>                :<span class="lineCov">     646288 :             deselect_last();</span></a>
<a name="496"><span class="lineNum">     496 </span>                :<span class="lineCov">     646288 :             should_shift  = false;</span></a>
<a name="497"><span class="lineNum">     497 </span>                :            : </a>
<a name="498"><span class="lineNum">     498 </span>                :            :             // After SHIFTing to an omission branch, the `next_utxo` might have the same effective value as the UTXO we</a>
<a name="499"><span class="lineNum">     499 </span>                :            :             // just omitted. Since lower weight is our tiebreaker on UTXOs with equal effective value for sorting, if it</a>
<a name="500"><span class="lineNum">     500 </span>                :            :             // ties on the effective value, it _must_ have the same weight (i.e. be a &quot;clone&quot; of the prior UTXO) or a</a>
<a name="501"><span class="lineNum">     501 </span>                :            :             // higher weight. If so, selecting `next_utxo` would produce an equivalent or worse selection as one we</a>
<a name="502"><span class="lineNum">     502 </span>                :            :             // previously evaluated. In that case, increment `next_utxo` until we find a UTXO with a differing amount.</a>
<a name="503"><span class="lineNum">     503 </span>        [<span class="branchCov" title="Branch 0 was taken 47472 times"> + </span><span class="branchCov" title="Branch 1 was taken 646133 times"> + </span>]:<span class="lineCov">    1339893 :             while (utxo_pool[next_utxo - 1].GetSelectionAmount() == utxo_pool[next_utxo].GetSelectionAmount()) {</span></a>
<a name="504"><span class="lineNum">     504 </span>        [<span class="branchCov" title="Branch 0 was taken 47317 times"> + </span><span class="branchCov" title="Branch 1 was taken 155 times"> + </span>]:<span class="lineCov">      47472 :                 if (next_utxo &gt;= utxo_pool.size() - 1) {</span></a>
<a name="505"><span class="lineNum">     505 </span>                :            :                     // Reached end of UTXO pool skipping clones: SHIFT instead</a>
<a name="506"><span class="lineNum">     506 </span>                :            :                     should_shift = true;</a>
<a name="507"><span class="lineNum">     507 </span>                :            :                     break;</a>
<a name="508"><span class="lineNum">     508 </span>                :            :                 }</a>
<a name="509"><span class="lineNum">     509 </span>                :            :                 // Skip clone: previous UTXO is equivalent and unselected</a>
<a name="510"><span class="lineNum">     510 </span>                :<span class="lineCov">      47317 :                 ++next_utxo;</span></a>
<a name="511"><span class="lineNum">     511 </span>                :            :             }</a>
<a name="512"><span class="lineNum">     512 </span>                :            :         }</a>
<a name="513"><span class="lineNum">     513 </span>                :            :     }</a>
<a name="514"><span class="lineNum">     514 </span>                :            : </a>
<a name="515"><span class="lineNum">     515 </span>                :<span class="lineCov">        562 :     result.SetSelectionsEvaluated(curr_try);</span></a>
<a name="516"><span class="lineNum">     516 </span>                :            : </a>
<a name="517"><span class="lineNum">     517 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 561 times"> + </span>]:<span class="lineCov">        562 :     if (best_selection.empty()) {</span></a>
<a name="518"><span class="lineNum">     518 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :         return max_tx_weight_exceeded ? ErrorMaxWeightExceeded() : util::Error();</span></a>
<a name="519"><span class="lineNum">     519 </span>                :            :     }</a>
<a name="520"><span class="lineNum">     520 </span>                :            : </a>
<a name="521"><span class="lineNum">     521 </span>        [<span class="branchCov" title="Branch 0 was taken 1162 times"> + </span><span class="branchCov" title="Branch 1 was taken 561 times"> + </span>]:<span class="lineCov">       1723 :     for (const size_t&amp; i : best_selection) {</span></a>
<a name="522"><span class="lineNum">     522 </span>        [<span class="branchCov" title="Branch 0 was taken 1162 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1162 :         result.AddInput(utxo_pool[i]);</span></a>
<a name="523"><span class="lineNum">     523 </span>                :            :     }</a>
<a name="524"><span class="lineNum">     524 </span>                :            : </a>
<a name="525"><span class="lineNum">     525 </span>                :<span class="lineCov">       1123 :     return result;</span></a>
<a name="526"><span class="lineNum">     526 </span>                :<span class="lineCov">       1459 : }</span></a>
<a name="527"><span class="lineNum">     527 </span>                :            : </a>
<a name="528"><span class="lineNum">     528 </span>                :            : class MinOutputGroupComparator</a>
<a name="529"><span class="lineNum">     529 </span>                :            : {</a>
<a name="530"><span class="lineNum">     530 </span>                :            : public:</a>
<a name="531"><span class="lineNum">     531 </span>                :<span class="lineCov">     623538 :     int operator() (const OutputGroup&amp; group1, const OutputGroup&amp; group2) const</span></a>
<a name="532"><span class="lineNum">     532 </span>                :            :     {</a>
<a name="533"><span class="lineNum">     533 </span>  [<span class="branchCov" title="Branch 0 was taken 192652 times"> + </span><span class="branchCov" title="Branch 1 was taken 199601 times"> + </span><span class="branchCov" title="Branch 2 was taken 81583 times"> + </span><span class="branchCov" title="Branch 3 was taken 149702 times"> + </span>]:<span class="lineCov">     623538 :         return group1.GetSelectionAmount() &gt; group2.GetSelectionAmount();</span></a>
<a name="534"><span class="lineNum">     534 </span>                :            :     }</a>
<a name="535"><span class="lineNum">     535 </span>                :            : };</a>
<a name="536"><span class="lineNum">     536 </span>                :            : </a>
<a name="537"><span class="lineNum">     537 </span>                :<span class="lineCov">       9309 : util::Result&lt;SelectionResult&gt; SelectCoinsSRD(const std::vector&lt;OutputGroup&gt;&amp; utxo_pool, CAmount target_value, CAmount change_fee, FastRandomContext&amp; rng,</span></a>
<a name="538"><span class="lineNum">     538 </span>                :            :                                              int max_weight)</a>
<a name="539"><span class="lineNum">     539 </span>                :            : {</a>
<a name="540"><span class="lineNum">     540 </span>        [<span class="branchCov" title="Branch 0 was taken 9309 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9309 :     SelectionResult result(target_value, SelectionAlgorithm::SRD);</span></a>
<a name="541"><span class="lineNum">     541 </span>        [<span class="branchCov" title="Branch 0 was taken 9309 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9309 :     std::priority_queue&lt;OutputGroup, std::vector&lt;OutputGroup&gt;, MinOutputGroupComparator&gt; heap;</span></a>
<a name="542"><span class="lineNum">     542 </span>                :            : </a>
<a name="543"><span class="lineNum">     543 </span>                :            :     // Include change for SRD as we want to avoid making really small change if the selection just</a>
<a name="544"><span class="lineNum">     544 </span>                :            :     // barely meets the target. Just use the lower bound change target instead of the randomly</a>
<a name="545"><span class="lineNum">     545 </span>                :            :     // generated one, since SRD will result in a random change amount anyway; avoid making the</a>
<a name="546"><span class="lineNum">     546 </span>                :            :     // target needlessly large.</a>
<a name="547"><span class="lineNum">     547 </span>                :<span class="lineCov">       9309 :     target_value += CHANGE_LOWER + change_fee;</span></a>
<a name="548"><span class="lineNum">     548 </span>                :            : </a>
<a name="549"><span class="lineNum">     549 </span>                :<span class="lineCov">       9309 :     std::vector&lt;size_t&gt; indexes;</span></a>
<a name="550"><span class="lineNum">     550 </span>        [<span class="branchCov" title="Branch 0 was taken 9309 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       9309 :     indexes.resize(utxo_pool.size());</span></a>
<a name="551"><span class="lineNum">     551 </span>                :<span class="lineCov">       9309 :     std::iota(indexes.begin(), indexes.end(), 0);</span></a>
<a name="552"><span class="lineNum">     552 </span>                :<span class="lineCov">       9309 :     Shuffle(indexes.begin(), indexes.end(), rng);</span></a>
<a name="553"><span class="lineNum">     553 </span>                :            : </a>
<a name="554"><span class="lineNum">     554 </span>                :<span class="lineCov">       9309 :     CAmount selected_eff_value = 0;</span></a>
<a name="555"><span class="lineNum">     555 </span>                :<span class="lineCov">       9309 :     int weight = 0;</span></a>
<a name="556"><span class="lineNum">     556 </span>                :<span class="lineCov">       9309 :     bool max_tx_weight_exceeded = false;</span></a>
<a name="557"><span class="lineNum">     557 </span>        [<span class="branchCov" title="Branch 0 was taken 102488 times"> + </span><span class="branchCov" title="Branch 1 was taken 1259 times"> + </span>]:<span class="lineCov">     103747 :     for (const size_t i : indexes) {</span></a>
<a name="558"><span class="lineNum">     558 </span>        [<span class="branchCov" title="Branch 0 was taken 102488 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     102488 :         const OutputGroup&amp; group = utxo_pool.at(i);</span></a>
<a name="559"><span class="lineNum">     559 </span>                :<span class="lineCov">     102488 :         Assume(group.GetSelectionAmount() &gt; 0);</span></a>
<a name="560"><span class="lineNum">     560 </span>                :            : </a>
<a name="561"><span class="lineNum">     561 </span>                :            :         // Add group to selection</a>
<a name="562"><span class="lineNum">     562 </span>        [<span class="branchCov" title="Branch 0 was taken 102488 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     102488 :         heap.push(group);</span></a>
<a name="563"><span class="lineNum">     563 </span>                :<span class="lineCov">     102488 :         selected_eff_value += group.GetSelectionAmount();</span></a>
<a name="564"><span class="lineNum">     564 </span>                :<span class="lineCov">     102488 :         weight += group.m_weight;</span></a>
<a name="565"><span class="lineNum">     565 </span>                :            : </a>
<a name="566"><span class="lineNum">     566 </span>                :            :         // If the selection weight exceeds the maximum allowed size, remove the least valuable inputs until we</a>
<a name="567"><span class="lineNum">     567 </span>                :            :         // are below max weight.</a>
<a name="568"><span class="lineNum">     568 </span>        [<span class="branchCov" title="Branch 0 was taken 1223 times"> + </span><span class="branchCov" title="Branch 1 was taken 101265 times"> + </span>]:<span class="lineCov">     102488 :         if (weight &gt; max_weight) {</span></a>
<a name="569"><span class="lineNum">     569 </span>                :<span class="lineCov">       1223 :             max_tx_weight_exceeded = true; // mark it in case we don't find any useful result.</span></a>
<a name="570"><span class="lineNum">     570 </span>                :<span class="lineCov">       1223 :             do {</span></a>
<a name="571"><span class="lineNum">     571 </span>                :<span class="lineCov">       1223 :                 const OutputGroup&amp; to_remove_group = heap.top();</span></a>
<a name="572"><span class="lineNum">     572 </span>                :<span class="lineCov">       1223 :                 selected_eff_value -= to_remove_group.GetSelectionAmount();</span></a>
<a name="573"><span class="lineNum">     573 </span>                :<span class="lineCov">       1223 :                 weight -= to_remove_group.m_weight;</span></a>
<a name="574"><span class="lineNum">     574 </span>                :<span class="lineCov">       1223 :                 heap.pop();</span></a>
<a name="575"><span class="lineNum">     575 </span>  [<span class="branchCov" title="Branch 0 was taken 1223 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1223 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">       2446 :             } while (!heap.empty() &amp;&amp; weight &gt; max_weight);</span></a>
<span class="lineNum">         </span>         <span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 1223 times"> + </span>]
<a name="576"><span class="lineNum">     576 </span>                :            :         }</a>
<a name="577"><span class="lineNum">     577 </span>                :            : </a>
<a name="578"><span class="lineNum">     578 </span>                :            :         // Now check if we are above the target</a>
<a name="579"><span class="lineNum">     579 </span>        [<span class="branchCov" title="Branch 0 was taken 8050 times"> + </span><span class="branchCov" title="Branch 1 was taken 94438 times"> + </span>]:<span class="lineCov">     102488 :         if (selected_eff_value &gt;= target_value) {</span></a>
<a name="580"><span class="lineNum">     580 </span>                :            :             // Result found, add it.</a>
<a name="581"><span class="lineNum">     581 </span>        [<span class="branchCov" title="Branch 0 was taken 66946 times"> + </span><span class="branchCov" title="Branch 1 was taken 8050 times"> + </span>]:<span class="lineCov">      74996 :             while (!heap.empty()) {</span></a>
<a name="582"><span class="lineNum">     582 </span>        [<span class="branchCov" title="Branch 0 was taken 66946 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      66946 :                 result.AddInput(heap.top());</span></a>
<a name="583"><span class="lineNum">     583 </span>                :<span class="lineCov">      66946 :                 heap.pop();</span></a>
<a name="584"><span class="lineNum">     584 </span>                :            :             }</a>
<a name="585"><span class="lineNum">     585 </span>                :<span class="lineCov">       8050 :             return result;</span></a>
<a name="586"><span class="lineNum">     586 </span>                :            :         }</a>
<a name="587"><span class="lineNum">     587 </span>                :            :     }</a>
<a name="588"><span class="lineNum">     588 </span>  [<span class="branchCov" title="Branch 0 was taken 19 times"> + </span><span class="branchCov" title="Branch 1 was taken 1240 times"> + </span><span class="branchCov" title="Branch 2 was taken 19 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      10549 :     return max_tx_weight_exceeded ? ErrorMaxWeightExceeded() : util::Error();</span></a>
<a name="589"><span class="lineNum">     589 </span>                :<span class="lineCov">       9309 : }</span></a>
<a name="590"><span class="lineNum">     590 </span>                :            : </a>
<a name="591"><span class="lineNum">     591 </span>                :            : /** Find a subset of the OutputGroups that is at least as large as, but as close as possible to, the</a>
<a name="592"><span class="lineNum">     592 </span>                :            :  * target amount; solve subset sum.</a>
<a name="593"><span class="lineNum">     593 </span>                :            :  * param@[in]   groups          OutputGroups to choose from, sorted by value in descending order.</a>
<a name="594"><span class="lineNum">     594 </span>                :            :  * param@[in]   nTotalLower     Total (effective) value of the UTXOs in groups.</a>
<a name="595"><span class="lineNum">     595 </span>                :            :  * param@[in]   nTargetValue    Subset sum target, not including change.</a>
<a name="596"><span class="lineNum">     596 </span>                :            :  * param@[out]  vfBest          Boolean vector representing the subset chosen that is closest to</a>
<a name="597"><span class="lineNum">     597 </span>                :            :  *                              nTargetValue, with indices corresponding to groups. If the ith</a>
<a name="598"><span class="lineNum">     598 </span>                :            :  *                              entry is true, that means the ith group in groups was selected.</a>
<a name="599"><span class="lineNum">     599 </span>                :            :  * param@[out]  nBest           Total amount of subset chosen that is closest to nTargetValue.</a>
<a name="600"><span class="lineNum">     600 </span>                :            :  * param@[in]   iterations      Maximum number of tries.</a>
<a name="601"><span class="lineNum">     601 </span>                :            :  */</a>
<a name="602"><span class="lineNum">     602 </span>                :<span class="lineCov">       6340 : static void ApproximateBestSubset(FastRandomContext&amp; insecure_rand, const std::vector&lt;OutputGroup&gt;&amp; groups,</span></a>
<a name="603"><span class="lineNum">     603 </span>                :            :                                   const CAmount&amp; nTotalLower, const CAmount&amp; nTargetValue,</a>
<a name="604"><span class="lineNum">     604 </span>                :            :                                   std::vector&lt;char&gt;&amp; vfBest, CAmount&amp; nBest, int iterations = 1000)</a>
<a name="605"><span class="lineNum">     605 </span>                :            : {</a>
<a name="606"><span class="lineNum">     606 </span>                :<span class="lineCov">       6340 :     std::vector&lt;char&gt; vfIncluded;</span></a>
<a name="607"><span class="lineNum">     607 </span>                :            : </a>
<a name="608"><span class="lineNum">     608 </span>                :            :     // Worst case &quot;best&quot; approximation is just all of the groups.</a>
<a name="609"><span class="lineNum">     609 </span>        [<span class="branchCov" title="Branch 0 was taken 6340 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       6340 :     vfBest.assign(groups.size(), true);</span></a>
<a name="610"><span class="lineNum">     610 </span>                :<span class="lineCov">       6340 :     nBest = nTotalLower;</span></a>
<a name="611"><span class="lineNum">     611 </span>                :            : </a>
<a name="612"><span class="lineNum">     612 </span>  [<span class="branchCov" title="Branch 0 was taken 5141280 times"> + </span><span class="branchCov" title="Branch 1 was taken 5127 times"> + </span><span class="branchCov" title="Branch 2 was taken 5140067 times"> + </span><span class="branchCov" title="Branch 3 was taken 1213 times"> + </span>]:<span class="lineCov">    5146407 :     for (int nRep = 0; nRep &lt; iterations &amp;&amp; nBest != nTargetValue; nRep++)</span></a>
<a name="613"><span class="lineNum">     613 </span>                :            :     {</a>
<a name="614"><span class="lineNum">     614 </span>        [<span class="branchCov" title="Branch 0 was taken 5140067 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5140067 :         vfIncluded.assign(groups.size(), false);</span></a>
<a name="615"><span class="lineNum">     615 </span>                :            :         CAmount nTotal = 0;</a>
<a name="616"><span class="lineNum">     616 </span>                :            :         bool fReachedTarget = false;</a>
<a name="617"><span class="lineNum">     617 </span>        [<span class="branchCov" title="Branch 0 was taken 7528324 times"> + </span><span class="branchCov" title="Branch 1 was taken 5140067 times"> + </span>]:<span class="lineCov">   12668391 :         for (int nPass = 0; nPass &lt; 2 &amp;&amp; !fReachedTarget; nPass++)</span></a>
<a name="618"><span class="lineNum">     618 </span>                :            :         {</a>
<a name="619"><span class="lineNum">     619 </span>        [<span class="branchCov" title="Branch 0 was taken 469885838 times"> + </span><span class="branchCov" title="Branch 1 was taken 7528324 times"> + </span>]:<span class="lineCov">  477414162 :             for (unsigned int i = 0; i &lt; groups.size(); i++)</span></a>
<a name="620"><span class="lineNum">     620 </span>                :            :             {</a>
<a name="621"><span class="lineNum">     621 </span>                :            :                 //The solver here uses a randomized algorithm,</a>
<a name="622"><span class="lineNum">     622 </span>                :            :                 //the randomness serves no real security purpose but is just</a>
<a name="623"><span class="lineNum">     623 </span>                :            :                 //needed to prevent degenerate behavior and it is important</a>
<a name="624"><span class="lineNum">     624 </span>                :            :                 //that the rng is fast. We do not use a constant random sequence,</a>
<a name="625"><span class="lineNum">     625 </span>                :            :                 //because there may be some privacy improvement by making</a>
<a name="626"><span class="lineNum">     626 </span>                :            :                 //the selection random.</a>
<a name="627"><span class="lineNum">     627 </span>  [<span class="branchCov" title="Branch 0 was taken 413621206 times"> + </span><span class="branchCov" title="Branch 1 was taken 56264632 times"> + </span><span class="branchCov" title="Branch 2 was taken 236154339 times"> + </span><span class="branchCov" title="Branch 3 was taken 233731499 times"> + </span>]:<span class="lineCov">  883507044 :                 if (nPass == 0 ? insecure_rand.randbool() : !vfIncluded[i])</span></a>
<a name="628"><span class="lineNum">     628 </span>                :            :                 {</a>
<a name="629"><span class="lineNum">     629 </span>        [<span class="branchCov" title="Branch 0 was taken 176523077 times"> + </span><span class="branchCov" title="Branch 1 was taken 59631262 times"> + </span>]:<span class="lineCov">  236154339 :                     nTotal += groups[i].GetSelectionAmount();</span></a>
<a name="630"><span class="lineNum">     630 </span>        [<span class="branchCov" title="Branch 0 was taken 176523077 times"> + </span><span class="branchCov" title="Branch 1 was taken 59631262 times"> + </span>]:<span class="lineCov">  236154339 :                     vfIncluded[i] = true;</span></a>
<a name="631"><span class="lineNum">     631 </span>        [<span class="branchCov" title="Branch 0 was taken 176523077 times"> + </span><span class="branchCov" title="Branch 1 was taken 59631262 times"> + </span>]:<span class="lineCov">  236154339 :                     if (nTotal &gt;= nTargetValue)</span></a>
<a name="632"><span class="lineNum">     632 </span>                :            :                     {</a>
<a name="633"><span class="lineNum">     633 </span>                :<span class="lineCov">  176523077 :                         fReachedTarget = true;</span></a>
<a name="634"><span class="lineNum">     634 </span>                :            :                         // If the total is between nTargetValue and nBest, it's our new best</a>
<a name="635"><span class="lineNum">     635 </span>                :            :                         // approximation.</a>
<a name="636"><span class="lineNum">     636 </span>        [<span class="branchCov" title="Branch 0 was taken 30793 times"> + </span><span class="branchCov" title="Branch 1 was taken 176492284 times"> + </span>]:<span class="lineCov">  176523077 :                         if (nTotal &lt; nBest)</span></a>
<a name="637"><span class="lineNum">     637 </span>                :            :                         {</a>
<a name="638"><span class="lineNum">     638 </span>                :<span class="lineCov">      30793 :                             nBest = nTotal;</span></a>
<a name="639"><span class="lineNum">     639 </span>        [<span class="branchCov" title="Branch 0 was taken 30793 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      30793 :                             vfBest = vfIncluded;</span></a>
<a name="640"><span class="lineNum">     640 </span>                :            :                         }</a>
<a name="641"><span class="lineNum">     641 </span>                :<span class="lineCov">  176523077 :                         nTotal -= groups[i].GetSelectionAmount();</span></a>
<a name="642"><span class="lineNum">     642 </span>                :<span class="lineCov">  176523077 :                         vfIncluded[i] = false;</span></a>
<a name="643"><span class="lineNum">     643 </span>                :            :                     }</a>
<a name="644"><span class="lineNum">     644 </span>                :            :                 }</a>
<a name="645"><span class="lineNum">     645 </span>                :            :             }</a>
<a name="646"><span class="lineNum">     646 </span>                :            :         }</a>
<a name="647"><span class="lineNum">     647 </span>                :            :     }</a>
<a name="648"><span class="lineNum">     648 </span>                :<span class="lineCov">       6340 : }</span></a>
<a name="649"><span class="lineNum">     649 </span>                :            : </a>
<a name="650"><span class="lineNum">     650 </span>                :<span class="lineCov">      14907 : util::Result&lt;SelectionResult&gt; KnapsackSolver(std::vector&lt;OutputGroup&gt;&amp; groups, const CAmount&amp; nTargetValue,</span></a>
<a name="651"><span class="lineNum">     651 </span>                :            :                                              CAmount change_target, FastRandomContext&amp; rng, int max_weight)</a>
<a name="652"><span class="lineNum">     652 </span>                :            : {</a>
<a name="653"><span class="lineNum">     653 </span>                :<span class="lineCov">      14907 :     SelectionResult result(nTargetValue, SelectionAlgorithm::KNAPSACK);</span></a>
<a name="654"><span class="lineNum">     654 </span>                :            : </a>
<a name="655"><span class="lineNum">     655 </span>                :            :     // List of values less than target</a>
<a name="656"><span class="lineNum">     656 </span>                :<span class="lineCov">      14907 :     std::optional&lt;OutputGroup&gt; lowest_larger;</span></a>
<a name="657"><span class="lineNum">     657 </span>                :            :     // Groups with selection amount smaller than the target and any change we might produce.</a>
<a name="658"><span class="lineNum">     658 </span>                :            :     // Don't include groups larger than this, because they will only cause us to overshoot.</a>
<a name="659"><span class="lineNum">     659 </span>                :<span class="lineCov">      14907 :     std::vector&lt;OutputGroup&gt; applicable_groups;</span></a>
<a name="660"><span class="lineNum">     660 </span>                :<span class="lineCov">      14907 :     CAmount nTotalLower = 0;</span></a>
<a name="661"><span class="lineNum">     661 </span>                :            : </a>
<a name="662"><span class="lineNum">     662 </span>                :<span class="lineCov">      14907 :     Shuffle(groups.begin(), groups.end(), rng);</span></a>
<a name="663"><span class="lineNum">     663 </span>                :            : </a>
<a name="664"><span class="lineNum">     664 </span>        [<span class="branchCov" title="Branch 0 was taken 743888 times"> + </span><span class="branchCov" title="Branch 1 was taken 13756 times"> + </span>]:<span class="lineCov">     757644 :     for (const OutputGroup&amp; group : groups) {</span></a>
<a name="665"><span class="lineNum">     665 </span>        [<span class="branchCov" title="Branch 0 was taken 1151 times"> + </span><span class="branchCov" title="Branch 1 was taken 742737 times"> + </span>]:<span class="lineCov">     743888 :         if (group.GetSelectionAmount() == nTargetValue) {</span></a>
<a name="666"><span class="lineNum">     666 </span>        [<span class="branchCov" title="Branch 0 was taken 1151 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1151 :             result.AddInput(group);</span></a>
<a name="667"><span class="lineNum">     667 </span>                :<span class="lineCov">       1151 :             return result;</span></a>
<a name="668"><span class="lineNum">     668 </span>        [<span class="branchCov" title="Branch 0 was taken 393708 times"> + </span><span class="branchCov" title="Branch 1 was taken 349029 times"> + </span>]:<span class="lineCov">     742737 :         } else if (group.GetSelectionAmount() &lt; nTargetValue + change_target) {</span></a>
<a name="669"><span class="lineNum">     669 </span>        [<span class="branchCov" title="Branch 0 was taken 393708 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     393708 :             applicable_groups.push_back(group);</span></a>
<a name="670"><span class="lineNum">     670 </span>                :<span class="lineCov">     393708 :             nTotalLower += group.GetSelectionAmount();</span></a>
<a name="671"><span class="lineNum">     671 </span>  [<span class="branchCov" title="Branch 0 was taken 339029 times"> + </span><span class="branchCov" title="Branch 1 was taken 10000 times"> + </span><span class="branchCov" title="Branch 2 was taken 6055 times"> + </span><span class="branchCov" title="Branch 3 was taken 332974 times"> + </span>]:<span class="lineCov">     349029 :         } else if (!lowest_larger || group.GetSelectionAmount() &lt; lowest_larger-&gt;GetSelectionAmount()) {</span></a>
<a name="672"><span class="lineNum">     672 </span>        [<span class="branchCov" title="Branch 0 was taken 16055 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      16055 :             lowest_larger = group;</span></a>
<a name="673"><span class="lineNum">     673 </span>                :            :         }</a>
<a name="674"><span class="lineNum">     674 </span>                :            :     }</a>
<a name="675"><span class="lineNum">     675 </span>                :            : </a>
<a name="676"><span class="lineNum">     676 </span>        [<span class="branchCov" title="Branch 0 was taken 525 times"> + </span><span class="branchCov" title="Branch 1 was taken 13231 times"> + </span>]:<span class="lineCov">      13756 :     if (nTotalLower == nTargetValue) {</span></a>
<a name="677"><span class="lineNum">     677 </span>        [<span class="branchCov" title="Branch 0 was taken 2046 times"> + </span><span class="branchCov" title="Branch 1 was taken 525 times"> + </span>]:<span class="lineCov">       2571 :         for (const auto&amp; group : applicable_groups) {</span></a>
<a name="678"><span class="lineNum">     678 </span>        [<span class="branchCov" title="Branch 0 was taken 2046 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2046 :             result.AddInput(group);</span></a>
<a name="679"><span class="lineNum">     679 </span>                :            :         }</a>
<a name="680"><span class="lineNum">     680 </span>                :<span class="lineCov">        525 :         return result;</span></a>
<a name="681"><span class="lineNum">     681 </span>                :            :     }</a>
<a name="682"><span class="lineNum">     682 </span>                :            : </a>
<a name="683"><span class="lineNum">     683 </span>        [<span class="branchCov" title="Branch 0 was taken 9488 times"> + </span><span class="branchCov" title="Branch 1 was taken 3743 times"> + </span>]:<span class="lineCov">      13231 :     if (nTotalLower &lt; nTargetValue) {</span></a>
<a name="684"><span class="lineNum">     684 </span>        [<span class="branchCov" title="Branch 0 was taken 1750 times"> + </span><span class="branchCov" title="Branch 1 was taken 7738 times"> + </span>]:<span class="lineCov">       9488 :         if (!lowest_larger) return util::Error();</span></a>
<a name="685"><span class="lineNum">     685 </span>        [<span class="branchCov" title="Branch 0 was taken 7738 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       7738 :         result.AddInput(*lowest_larger);</span></a>
<a name="686"><span class="lineNum">     686 </span>                :<span class="lineCov">       7738 :         return result;</span></a>
<a name="687"><span class="lineNum">     687 </span>                :            :     }</a>
<a name="688"><span class="lineNum">     688 </span>                :            : </a>
<a name="689"><span class="lineNum">     689 </span>                :            :     // Solve subset sum by stochastic approximation</a>
<a name="690"><span class="lineNum">     690 </span>                :<span class="lineCov">       3743 :     std::sort(applicable_groups.begin(), applicable_groups.end(), descending);</span></a>
<a name="691"><span class="lineNum">     691 </span>                :<span class="lineCov">       3743 :     std::vector&lt;char&gt; vfBest;</span></a>
<a name="692"><span class="lineNum">     692 </span>                :<span class="lineCov">       3743 :     CAmount nBest;</span></a>
<a name="693"><span class="lineNum">     693 </span>                :            : </a>
<a name="694"><span class="lineNum">     694 </span>        [<span class="branchCov" title="Branch 0 was taken 3743 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3743 :     ApproximateBestSubset(rng, applicable_groups, nTotalLower, nTargetValue, vfBest, nBest);</span></a>
<a name="695"><span class="lineNum">     695 </span>  [<span class="branchCov" title="Branch 0 was taken 2731 times"> + </span><span class="branchCov" title="Branch 1 was taken 1012 times"> + </span><span class="branchCov" title="Branch 2 was taken 2597 times"> + </span><span class="branchCov" title="Branch 3 was taken 134 times"> + </span>]:<span class="lineCov">       3743 :     if (nBest != nTargetValue &amp;&amp; nTotalLower &gt;= nTargetValue + change_target) {</span></a>
<a name="696"><span class="lineNum">     696 </span>        [<span class="branchCov" title="Branch 0 was taken 2597 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2597 :         ApproximateBestSubset(rng, applicable_groups, nTotalLower, nTargetValue + change_target, vfBest, nBest);</span></a>
<a name="697"><span class="lineNum">     697 </span>                :            :     }</a>
<a name="698"><span class="lineNum">     698 </span>                :            : </a>
<a name="699"><span class="lineNum">     699 </span>                :            :     // If we have a bigger coin and (either the stochastic approximation didn't find a good solution,</a>
<a name="700"><span class="lineNum">     700 </span>                :            :     //                                   or the next bigger coin is closer), return the bigger coin</a>
<a name="701"><span class="lineNum">     701 </span>        [<span class="branchCov" title="Branch 0 was taken 2161 times"> + </span><span class="branchCov" title="Branch 1 was taken 1582 times"> + </span>]:<span class="lineCov">       3743 :     if (lowest_larger &amp;&amp;</span></a>
<a name="702"><span class="lineNum">     702 </span>  [<span class="branchCov" title="Branch 0 was taken 2161 times"> + </span><span class="branchCov" title="Branch 1 was taken 1582 times"> + </span><span class="branchCov" title="Branch 2 was taken 1660 times"> + </span><span class="branchCov" title="Branch 3 was taken 501 times"> + </span> :<span class="lineCov">       3743 :         ((nBest != nTargetValue &amp;&amp; nBest &lt; nTargetValue + change_target) || lowest_larger-&gt;GetSelectionAmount() &lt;= nBest)) {</span></a>
<span class="lineNum">         </span>   <span class="branchCov" title="Branch 4 was taken 1554 times"> + </span><span class="branchCov" title="Branch 5 was taken 106 times"> + </span><span class="branchCov" title="Branch 6 was taken 212 times"> + </span><span class="branchCov" title="Branch 7 was taken 1843 times"> + </span>]
<a name="703"><span class="lineNum">     703 </span>        [<span class="branchCov" title="Branch 0 was taken 318 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        318 :         result.AddInput(*lowest_larger);</span></a>
<a name="704"><span class="lineNum">     704 </span>                :            :     } else {</a>
<a name="705"><span class="lineNum">     705 </span>        [<span class="branchCov" title="Branch 0 was taken 372600 times"> + </span><span class="branchCov" title="Branch 1 was taken 3425 times"> + </span>]:<span class="lineCov">     376025 :         for (unsigned int i = 0; i &lt; applicable_groups.size(); i++) {</span></a>
<a name="706"><span class="lineNum">     706 </span>        [<span class="branchCov" title="Branch 0 was taken 163779 times"> + </span><span class="branchCov" title="Branch 1 was taken 208821 times"> + </span>]:<span class="lineCov">     372600 :             if (vfBest[i]) {</span></a>
<a name="707"><span class="lineNum">     707 </span>        [<span class="branchCov" title="Branch 0 was taken 163779 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     163779 :                 result.AddInput(applicable_groups[i]);</span></a>
<a name="708"><span class="lineNum">     708 </span>                :            :             }</a>
<a name="709"><span class="lineNum">     709 </span>                :            :         }</a>
<a name="710"><span class="lineNum">     710 </span>                :            : </a>
<a name="711"><span class="lineNum">     711 </span>                :            :         // If the result exceeds the maximum allowed size, return closest UTXO above the target</a>
<a name="712"><span class="lineNum">     712 </span>        [<span class="branchCov" title="Branch 0 was taken 19 times"> + </span><span class="branchCov" title="Branch 1 was taken 3406 times"> + </span>]:<span class="lineCov">       3425 :         if (result.GetWeight() &gt; max_weight) {</span></a>
<a name="713"><span class="lineNum">     713 </span>                :            :             // No coin above target, nothing to do.</a>
<a name="714"><span class="lineNum">     714 </span>  [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         19 :             if (!lowest_larger) return ErrorMaxWeightExceeded();</span></a>
<a name="715"><span class="lineNum">     715 </span>                :            : </a>
<a name="716"><span class="lineNum">     716 </span>                :            :             // Return closest UTXO above target</a>
<a name="717"><span class="lineNum">     717 </span>                :<span class="lineCov">          1 :             result.Clear();</span></a>
<a name="718"><span class="lineNum">     718 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :             result.AddInput(*lowest_larger);</span></a>
<a name="719"><span class="lineNum">     719 </span>                :            :         }</a>
<a name="720"><span class="lineNum">     720 </span>                :            : </a>
<a name="721"><span class="lineNum">     721 </span>  [<span class="branchCov" title="Branch 0 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       3407 :         if (LogAcceptCategory(BCLog::SELECTCOINS, BCLog::Level::Debug)) {</span></a>
<a name="722"><span class="lineNum">     722 </span>        [<span class="branchCov" title="Branch 0 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3407 :             std::string log_message{&quot;Coin selection best subset: &quot;};</span></a>
<a name="723"><span class="lineNum">     723 </span>        [<span class="branchCov" title="Branch 0 was taken 345510 times"> + </span><span class="branchCov" title="Branch 1 was taken 3407 times"> + </span>]:<span class="lineCov">     348917 :             for (unsigned int i = 0; i &lt; applicable_groups.size(); i++) {</span></a>
<a name="724"><span class="lineNum">     724 </span>        [<span class="branchCov" title="Branch 0 was taken 137007 times"> + </span><span class="branchCov" title="Branch 1 was taken 208503 times"> + </span>]:<span class="lineCov">     345510 :                 if (vfBest[i]) {</span></a>
<a name="725"><span class="lineNum">     725 </span>  [<span class="branchCov" title="Branch 0 was taken 137007 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 137007 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">     619524 :                     log_message += strprintf(&quot;%s &quot;, FormatMoney(applicable_groups[i].m_value));</span></a>
<a name="726"><span class="lineNum">     726 </span>                :            :                 }</a>
<a name="727"><span class="lineNum">     727 </span>                :            :             }</a>
<a name="728"><span class="lineNum">     728 </span>  [<span class="branchCov" title="Branch 0 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">      10221 :             LogPrint(BCLog::SELECTCOINS, &quot;%stotal %s\n&quot;, log_message, FormatMoney(nBest));</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 3407 times"> + </span> 
<span class="lineNum">         </span>      <span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 3407 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<a name="729"><span class="lineNum">     729 </span>                :<span class="lineNoCov">          0 :         }</span></a>
<a name="730"><span class="lineNum">     730 </span>                :            :     }</a>
<a name="731"><span class="lineNum">     731 </span>                :            : </a>
<a name="732"><span class="lineNum">     732 </span>                :<span class="lineCov">       7468 :     return result;</span></a>
<a name="733"><span class="lineNum">     733 </span>        [<span class="branchCov" title="Branch 0 was taken 10000 times"> + </span><span class="branchCov" title="Branch 1 was taken 4907 times"> + </span>]:<span class="lineCov">      24907 : }</span></a>
<a name="734"><span class="lineNum">     734 </span>                :            : </a>
<a name="735"><span class="lineNum">     735 </span>                :            : /******************************************************************************</a>
<a name="736"><span class="lineNum">     736 </span>                :            : </a>
<a name="737"><span class="lineNum">     737 </span>                :            :  OutputGroup</a>
<a name="738"><span class="lineNum">     738 </span>                :            : </a>
<a name="739"><span class="lineNum">     739 </span>                :            :  ******************************************************************************/</a>
<a name="740"><span class="lineNum">     740 </span>                :            : </a>
<a name="741"><span class="lineNum">     741 </span>                :<span class="lineCov">    1113991 : void OutputGroup::Insert(const std::shared_ptr&lt;COutput&gt;&amp; output, size_t ancestors, size_t descendants) {</span></a>
<a name="742"><span class="lineNum">     742 </span>                :<span class="lineCov">    1113991 :     m_outputs.push_back(output);</span></a>
<a name="743"><span class="lineNum">     743 </span>                :<span class="lineCov">    1113991 :     auto&amp; coin = *m_outputs.back();</span></a>
<a name="744"><span class="lineNum">     744 </span>                :            : </a>
<a name="745"><span class="lineNum">     745 </span>                :<span class="lineCov">    1113991 :     fee += coin.GetFee();</span></a>
<a name="746"><span class="lineNum">     746 </span>                :            : </a>
<a name="747"><span class="lineNum">     747 </span>        [<span class="branchCov" title="Branch 0 was taken 382614 times"> + </span><span class="branchCov" title="Branch 1 was taken 731377 times"> + </span>]:<span class="lineCov">    1113991 :     coin.long_term_fee = coin.input_bytes &lt; 0 ? 0 : m_long_term_feerate.GetFee(coin.input_bytes);</span></a>
<a name="748"><span class="lineNum">     748 </span>                :<span class="lineCov">    1113991 :     long_term_fee += coin.long_term_fee;</span></a>
<a name="749"><span class="lineNum">     749 </span>                :            : </a>
<a name="750"><span class="lineNum">     750 </span>                :<span class="lineCov">    1113991 :     effective_value += coin.GetEffectiveValue();</span></a>
<a name="751"><span class="lineNum">     751 </span>                :            : </a>
<a name="752"><span class="lineNum">     752 </span>                :<span class="lineCov">    1113991 :     m_from_me &amp;= coin.from_me;</span></a>
<a name="753"><span class="lineNum">     753 </span>                :<span class="lineCov">    1113991 :     m_value += coin.txout.nValue;</span></a>
<a name="754"><span class="lineNum">     754 </span>        [<span class="branchCov" title="Branch 0 was taken 1016339 times"> + </span><span class="branchCov" title="Branch 1 was taken 97652 times"> + </span>]:<span class="lineCov">    1113991 :     m_depth = std::min(m_depth, coin.depth);</span></a>
<a name="755"><span class="lineNum">     755 </span>                :            :     // ancestors here express the number of ancestors the new coin will end up having, which is</a>
<a name="756"><span class="lineNum">     756 </span>                :            :     // the sum, rather than the max; this will overestimate in the cases where multiple inputs</a>
<a name="757"><span class="lineNum">     757 </span>                :            :     // have common ancestors</a>
<a name="758"><span class="lineNum">     758 </span>                :<span class="lineCov">    1113991 :     m_ancestors += ancestors;</span></a>
<a name="759"><span class="lineNum">     759 </span>                :            :     // descendants is the count as seen from the top ancestor, not the descendants as seen from the</a>
<a name="760"><span class="lineNum">     760 </span>                :            :     // coin itself; thus, this value is counted as the max, not the sum</a>
<a name="761"><span class="lineNum">     761 </span>        [<span class="branchCov" title="Branch 0 was taken 153039 times"> + </span><span class="branchCov" title="Branch 1 was taken 960952 times"> + </span>]:<span class="lineCov">    1113991 :     m_descendants = std::max(m_descendants, descendants);</span></a>
<a name="762"><span class="lineNum">     762 </span>                :            : </a>
<a name="763"><span class="lineNum">     763 </span>        [<span class="branchCov" title="Branch 0 was taken 382614 times"> + </span><span class="branchCov" title="Branch 1 was taken 731377 times"> + </span>]:<span class="lineCov">    1113991 :     if (output-&gt;input_bytes &gt; 0) {</span></a>
<a name="764"><span class="lineNum">     764 </span>                :<span class="lineCov">     382614 :         m_weight += output-&gt;input_bytes * WITNESS_SCALE_FACTOR;</span></a>
<a name="765"><span class="lineNum">     765 </span>                :            :     }</a>
<a name="766"><span class="lineNum">     766 </span>                :<span class="lineCov">    1113991 : }</span></a>
<a name="767"><span class="lineNum">     767 </span>                :            : </a>
<a name="768"><span class="lineNum">     768 </span>                :<span class="lineCov">    2618539 : bool OutputGroup::EligibleForSpending(const CoinEligibilityFilter&amp; eligibility_filter) const</span></a>
<a name="769"><span class="lineNum">     769 </span>                :            : {</a>
<a name="770"><span class="lineNum">     770 </span>        [<span class="branchCov" title="Branch 0 was taken 1287334 times"> + </span><span class="branchCov" title="Branch 1 was taken 1331205 times"> + </span>]:<span class="lineCov">    2618539 :     return m_depth &gt;= (m_from_me ? eligibility_filter.conf_mine : eligibility_filter.conf_theirs)</span></a>
<a name="771"><span class="lineNum">     771 </span>        [<span class="branchCov" title="Branch 0 was taken 2285686 times"> + </span><span class="branchCov" title="Branch 1 was taken 15361 times"> + </span>]:<span class="lineCov">    2301047 :         &amp;&amp; m_ancestors &lt;= eligibility_filter.max_ancestors</span></a>
<a name="772"><span class="lineNum">     772 </span>  [<span class="branchCov" title="Branch 0 was taken 2301047 times"> + </span><span class="branchCov" title="Branch 1 was taken 317492 times"> + </span><span class="branchCov" title="Branch 2 was taken 197 times"> + </span><span class="branchCov" title="Branch 3 was taken 2285489 times"> + </span>]:<span class="lineCov">    4904225 :         &amp;&amp; m_descendants &lt;= eligibility_filter.max_descendants;</span></a>
<a name="773"><span class="lineNum">     773 </span>                :            : }</a>
<a name="774"><span class="lineNum">     774 </span>                :            : </a>
<a name="775"><span class="lineNum">     775 </span>                :<span class="lineCov">  463792807 : CAmount OutputGroup::GetSelectionAmount() const</span></a>
<a name="776"><span class="lineNum">     776 </span>                :            : {</a>
<a name="777"><span class="lineNum">     777 </span>        [<span class="branchCov" title="Branch 0 was taken 10354094 times"> + </span><span class="branchCov" title="Branch 1 was taken 453438713 times"> + </span>]:<span class="lineCov">  463792807 :     return m_subtract_fee_outputs ? m_value : effective_value;</span></a>
<a name="778"><span class="lineNum">     778 </span>                :            : }</a>
<a name="779"><span class="lineNum">     779 </span>                :            : </a>
<a name="780"><span class="lineNum">     780 </span>                :<span class="lineCov">    2285253 : void OutputGroupTypeMap::Push(const OutputGroup&amp; group, OutputType type, bool insert_positive, bool insert_mixed)</span></a>
<a name="781"><span class="lineNum">     781 </span>                :            : {</a>
<a name="782"><span class="lineNum">     782 </span>        [<span class="branchCov" title="Branch 0 was taken 2285253 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    2285253 :     if (group.m_outputs.empty()) return;</span></a>
<a name="783"><span class="lineNum">     783 </span>                :            : </a>
<a name="784"><span class="lineNum">     784 </span>                :<span class="lineCov">    2285253 :     Groups&amp; groups = groups_by_type[type];</span></a>
<a name="785"><span class="lineNum">     785 </span>  [<span class="branchCov" title="Branch 0 was taken 1924361 times"> + </span><span class="branchCov" title="Branch 1 was taken 360892 times"> + </span><span class="branchCov" title="Branch 2 was taken 1924175 times"> + </span><span class="branchCov" title="Branch 3 was taken 186 times"> + </span>]:<span class="lineCov">    2285253 :     if (insert_positive &amp;&amp; group.GetSelectionAmount() &gt; 0) {</span></a>
<a name="786"><span class="lineNum">     786 </span>                :<span class="lineCov">    1924175 :         groups.positive_group.emplace_back(group);</span></a>
<a name="787"><span class="lineNum">     787 </span>                :<span class="lineCov">    1924175 :         all_groups.positive_group.emplace_back(group);</span></a>
<a name="788"><span class="lineNum">     788 </span>                :            :     }</a>
<a name="789"><span class="lineNum">     789 </span>        [<span class="branchCov" title="Branch 0 was taken 1924503 times"> + </span><span class="branchCov" title="Branch 1 was taken 360750 times"> + </span>]:<span class="lineCov">    2285253 :     if (insert_mixed) {</span></a>
<a name="790"><span class="lineNum">     790 </span>                :<span class="lineCov">    1924503 :         groups.mixed_group.emplace_back(group);</span></a>
<a name="791"><span class="lineNum">     791 </span>                :<span class="lineCov">    1924503 :         all_groups.mixed_group.emplace_back(group);</span></a>
<a name="792"><span class="lineNum">     792 </span>                :            :     }</a>
<a name="793"><span class="lineNum">     793 </span>                :            : }</a>
<a name="794"><span class="lineNum">     794 </span>                :            : </a>
<a name="795"><span class="lineNum">     795 </span>                :<span class="lineCov">      18498 : CAmount SelectionResult::GetSelectionWaste(CAmount change_cost, CAmount target, bool use_effective_value)</span></a>
<a name="796"><span class="lineNum">     796 </span>                :            : {</a>
<a name="797"><span class="lineNum">     797 </span>                :            :     // This function should not be called with empty inputs as that would mean the selection failed</a>
<a name="798"><span class="lineNum">     798 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 18498 times"> + </span>]:<span class="lineCov">      18498 :     assert(!m_selected_inputs.empty());</span></a>
<a name="799"><span class="lineNum">     799 </span>                :            : </a>
<a name="800"><span class="lineNum">     800 </span>                :            :     // Always consider the cost of spending an input now vs in the future.</a>
<a name="801"><span class="lineNum">     801 </span>                :<span class="lineCov">      18498 :     CAmount waste = 0;</span></a>
<a name="802"><span class="lineNum">     802 </span>        [<span class="branchCov" title="Branch 0 was taken 224744 times"> + </span><span class="branchCov" title="Branch 1 was taken 18498 times"> + </span>]:<span class="lineCov">     243242 :     for (const auto&amp; coin_ptr : m_selected_inputs) {</span></a>
<a name="803"><span class="lineNum">     803 </span>                :<span class="lineCov">     224744 :         const COutput&amp; coin = *coin_ptr;</span></a>
<a name="804"><span class="lineNum">     804 </span>                :<span class="lineCov">     224744 :         waste += coin.GetFee() - coin.long_term_fee;</span></a>
<a name="805"><span class="lineNum">     805 </span>                :            :     }</a>
<a name="806"><span class="lineNum">     806 </span>                :            :     // Bump fee of whole selection may diverge from sum of individual bump fees</a>
<a name="807"><span class="lineNum">     807 </span>                :<span class="lineCov">      18498 :     waste -= bump_fee_group_discount;</span></a>
<a name="808"><span class="lineNum">     808 </span>                :            : </a>
<a name="809"><span class="lineNum">     809 </span>        [<span class="branchCov" title="Branch 0 was taken 17888 times"> + </span><span class="branchCov" title="Branch 1 was taken 610 times"> + </span>]:<span class="lineCov">      18498 :     if (change_cost) {</span></a>
<a name="810"><span class="lineNum">     810 </span>                :            :         // Consider the cost of making change and spending it in the future</a>
<a name="811"><span class="lineNum">     811 </span>                :            :         // If we aren't making change, the caller should've set change_cost to 0</a>
<a name="812"><span class="lineNum">     812 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 17888 times"> + </span>]:<span class="lineCov">      17888 :         assert(change_cost &gt; 0);</span></a>
<a name="813"><span class="lineNum">     813 </span>                :<span class="lineCov">      17888 :         waste += change_cost;</span></a>
<a name="814"><span class="lineNum">     814 </span>                :            :     } else {</a>
<a name="815"><span class="lineNum">     815 </span>                :            :         // When we are not making change (change_cost == 0), consider the excess we are throwing away to fees</a>
<a name="816"><span class="lineNum">     816 </span>        [<span class="branchCov" title="Branch 0 was taken 409 times"> + </span><span class="branchCov" title="Branch 1 was taken 201 times"> + </span>]:<span class="lineCov">        610 :         CAmount selected_effective_value = use_effective_value ? GetSelectedEffectiveValue() : GetSelectedValue();</span></a>
<a name="817"><span class="lineNum">     817 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 610 times"> + </span>]:<span class="lineCov">        610 :         assert(selected_effective_value &gt;= target);</span></a>
<a name="818"><span class="lineNum">     818 </span>                :<span class="lineCov">        610 :         waste += selected_effective_value - target;</span></a>
<a name="819"><span class="lineNum">     819 </span>                :            :     }</a>
<a name="820"><span class="lineNum">     820 </span>                :            : </a>
<a name="821"><span class="lineNum">     821 </span>                :<span class="lineCov">      18498 :     return waste;</span></a>
<a name="822"><span class="lineNum">     822 </span>                :            : }</a>
<a name="823"><span class="lineNum">     823 </span>                :            : </a>
<a name="824"><span class="lineNum">     824 </span>                :<span class="lineCov">       6618 : CAmount GenerateChangeTarget(const CAmount payment_value, const CAmount change_fee, FastRandomContext&amp; rng)</span></a>
<a name="825"><span class="lineNum">     825 </span>                :            : {</a>
<a name="826"><span class="lineNum">     826 </span>        [<span class="branchCov" title="Branch 0 was taken 158 times"> + </span><span class="branchCov" title="Branch 1 was taken 6460 times"> + </span>]:<span class="lineCov">       6618 :     if (payment_value &lt;= CHANGE_LOWER / 2) {</span></a>
<a name="827"><span class="lineNum">     827 </span>                :<span class="lineCov">        158 :         return change_fee + CHANGE_LOWER;</span></a>
<a name="828"><span class="lineNum">     828 </span>                :            :     } else {</a>
<a name="829"><span class="lineNum">     829 </span>                :            :         // random value between 50ksat and min (payment_value * 2, 1milsat)</a>
<a name="830"><span class="lineNum">     830 </span>        [<span class="branchCov" title="Branch 0 was taken 5924 times"> + </span><span class="branchCov" title="Branch 1 was taken 536 times"> + </span>]:<span class="lineCov">       6460 :         const auto upper_bound = std::min(payment_value * 2, CHANGE_UPPER);</span></a>
<a name="831"><span class="lineNum">     831 </span>                :<span class="lineCov">       6460 :         return change_fee + rng.randrange(upper_bound - CHANGE_LOWER) + CHANGE_LOWER;</span></a>
<a name="832"><span class="lineNum">     832 </span>                :            :     }</a>
<a name="833"><span class="lineNum">     833 </span>                :            : }</a>
<a name="834"><span class="lineNum">     834 </span>                :            : </a>
<a name="835"><span class="lineNum">     835 </span>                :<span class="lineCov">         18 : void SelectionResult::SetBumpFeeDiscount(const CAmount discount)</span></a>
<a name="836"><span class="lineNum">     836 </span>                :            : {</a>
<a name="837"><span class="lineNum">     837 </span>                :            :     // Overlapping ancestry can only lower the fees, not increase them</a>
<a name="838"><span class="lineNum">     838 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         18 :     assert (discount &gt;= 0);</span></a>
<a name="839"><span class="lineNum">     839 </span>                :<span class="lineCov">         18 :     bump_fee_group_discount = discount;</span></a>
<a name="840"><span class="lineNum">     840 </span>                :<span class="lineCov">         18 : }</span></a>
<a name="841"><span class="lineNum">     841 </span>                :            : </a>
<a name="842"><span class="lineNum">     842 </span>                :            : </a>
<a name="843"><span class="lineNum">     843 </span>                :<span class="lineCov">      18498 : void SelectionResult::ComputeAndSetWaste(const CAmount min_viable_change, const CAmount change_cost, const CAmount change_fee)</span></a>
<a name="844"><span class="lineNum">     844 </span>                :            : {</a>
<a name="845"><span class="lineNum">     845 </span>                :<span class="lineCov">      18498 :     const CAmount change = GetChange(min_viable_change, change_fee);</span></a>
<a name="846"><span class="lineNum">     846 </span>                :            : </a>
<a name="847"><span class="lineNum">     847 </span>        [<span class="branchCov" title="Branch 0 was taken 17895 times"> + </span><span class="branchCov" title="Branch 1 was taken 603 times"> + </span>]:<span class="lineCov">      18498 :     if (change &gt; 0) {</span></a>
<a name="848"><span class="lineNum">     848 </span>                :<span class="lineCov">      17895 :         m_waste = GetSelectionWaste(change_cost, m_target, m_use_effective);</span></a>
<a name="849"><span class="lineNum">     849 </span>                :            :     } else {</a>
<a name="850"><span class="lineNum">     850 </span>                :<span class="lineCov">        603 :         m_waste = GetSelectionWaste(0, m_target, m_use_effective);</span></a>
<a name="851"><span class="lineNum">     851 </span>                :            :     }</a>
<a name="852"><span class="lineNum">     852 </span>                :<span class="lineCov">      18498 : }</span></a>
<a name="853"><span class="lineNum">     853 </span>                :            : </a>
<a name="854"><span class="lineNum">     854 </span>                :<span class="lineCov">        562 : void SelectionResult::SetAlgoCompleted(bool algo_completed)</span></a>
<a name="855"><span class="lineNum">     855 </span>                :            : {</a>
<a name="856"><span class="lineNum">     856 </span>                :<span class="lineCov">        562 :     m_algo_completed = algo_completed;</span></a>
<a name="857"><span class="lineNum">     857 </span>                :<span class="lineCov">        562 : }</span></a>
<a name="858"><span class="lineNum">     858 </span>                :            : </a>
<a name="859"><span class="lineNum">     859 </span>                :<span class="lineNoCov">          0 : bool SelectionResult::GetAlgoCompleted() const</span></a>
<a name="860"><span class="lineNum">     860 </span>                :            : {</a>
<a name="861"><span class="lineNum">     861 </span>                :<span class="lineNoCov">          0 :     return m_algo_completed;</span></a>
<a name="862"><span class="lineNum">     862 </span>                :            : }</a>
<a name="863"><span class="lineNum">     863 </span>                :            : </a>
<a name="864"><span class="lineNum">     864 </span>                :<span class="lineCov">        562 : void SelectionResult::SetSelectionsEvaluated(size_t attempts)</span></a>
<a name="865"><span class="lineNum">     865 </span>                :            : {</a>
<a name="866"><span class="lineNum">     866 </span>                :<span class="lineCov">        562 :     m_selections_evaluated = attempts;</span></a>
<a name="867"><span class="lineNum">     867 </span>                :<span class="lineCov">        562 : }</span></a>
<a name="868"><span class="lineNum">     868 </span>                :            : </a>
<a name="869"><span class="lineNum">     869 </span>                :<span class="lineCov">         10 : size_t SelectionResult::GetSelectionsEvaluated() const</span></a>
<a name="870"><span class="lineNum">     870 </span>                :            : {</a>
<a name="871"><span class="lineNum">     871 </span>                :<span class="lineCov">         10 :     return m_selections_evaluated;</span></a>
<a name="872"><span class="lineNum">     872 </span>                :            : }</a>
<a name="873"><span class="lineNum">     873 </span>                :            : </a>
<a name="874"><span class="lineNum">     874 </span>                :<span class="lineCov">       6657 : CAmount SelectionResult::GetWaste() const</span></a>
<a name="875"><span class="lineNum">     875 </span>                :            : {</a>
<a name="876"><span class="lineNum">     876 </span>                :<span class="lineCov">       6657 :     return *Assert(m_waste);</span></a>
<a name="877"><span class="lineNum">     877 </span>                :            : }</a>
<a name="878"><span class="lineNum">     878 </span>                :            : </a>
<a name="879"><span class="lineNum">     879 </span>                :<span class="lineCov">      16914 : CAmount SelectionResult::GetSelectedValue() const</span></a>
<a name="880"><span class="lineNum">     880 </span>                :            : {</a>
<a name="881"><span class="lineNum">     881 </span>                :<span class="lineCov">     189390 :     return std::accumulate(m_selected_inputs.cbegin(), m_selected_inputs.cend(), CAmount{0}, [](CAmount sum, const auto&amp; coin) { return sum + coin-&gt;txout.nValue; });</span></a>
<a name="882"><span class="lineNum">     882 </span>                :            : }</a>
<a name="883"><span class="lineNum">     883 </span>                :            : </a>
<a name="884"><span class="lineNum">     884 </span>                :<span class="lineCov">      22378 : CAmount SelectionResult::GetSelectedEffectiveValue() const</span></a>
<a name="885"><span class="lineNum">     885 </span>                :            : {</a>
<a name="886"><span class="lineNum">     886 </span>                :<span class="lineCov">     358520 :     return std::accumulate(m_selected_inputs.cbegin(), m_selected_inputs.cend(), CAmount{0}, [](CAmount sum, const auto&amp; coin) { return sum + coin-&gt;GetEffectiveValue(); }) + bump_fee_group_discount;</span></a>
<a name="887"><span class="lineNum">     887 </span>                :            : }</a>
<a name="888"><span class="lineNum">     888 </span>                :            : </a>
<a name="889"><span class="lineNum">     889 </span>                :<span class="lineCov">       6548 : CAmount SelectionResult::GetTotalBumpFees() const</span></a>
<a name="890"><span class="lineNum">     890 </span>                :            : {</a>
<a name="891"><span class="lineNum">     891 </span>                :<span class="lineCov">      27758 :     return std::accumulate(m_selected_inputs.cbegin(), m_selected_inputs.cend(), CAmount{0}, [](CAmount sum, const auto&amp; coin) { return sum + coin-&gt;ancestor_bump_fees; }) - bump_fee_group_discount;</span></a>
<a name="892"><span class="lineNum">     892 </span>                :            : }</a>
<a name="893"><span class="lineNum">     893 </span>                :            : </a>
<a name="894"><span class="lineNum">     894 </span>                :<span class="lineCov">         13 : void SelectionResult::Clear()</span></a>
<a name="895"><span class="lineNum">     895 </span>                :            : {</a>
<a name="896"><span class="lineNum">     896 </span>                :<span class="lineCov">         13 :     m_selected_inputs.clear();</span></a>
<a name="897"><span class="lineNum">     897 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 13 times"> + </span>]:<span class="lineCov">         13 :     m_waste.reset();</span></a>
<a name="898"><span class="lineNum">     898 </span>                :<span class="lineCov">         13 :     m_weight = 0;</span></a>
<a name="899"><span class="lineNum">     899 </span>                :<span class="lineCov">         13 : }</span></a>
<a name="900"><span class="lineNum">     900 </span>                :            : </a>
<a name="901"><span class="lineNum">     901 </span>                :<span class="lineCov">     270962 : void SelectionResult::AddInput(const OutputGroup&amp; group)</span></a>
<a name="902"><span class="lineNum">     902 </span>                :            : {</a>
<a name="903"><span class="lineNum">     903 </span>                :            :     // As it can fail, combine inputs first</a>
<a name="904"><span class="lineNum">     904 </span>                :<span class="lineCov">     270962 :     InsertInputs(group.m_outputs);</span></a>
<a name="905"><span class="lineNum">     905 </span>                :<span class="lineCov">     270962 :     m_use_effective = !group.m_subtract_fee_outputs;</span></a>
<a name="906"><span class="lineNum">     906 </span>                :            : </a>
<a name="907"><span class="lineNum">     907 </span>                :<span class="lineCov">     270962 :     m_weight += group.m_weight;</span></a>
<a name="908"><span class="lineNum">     908 </span>                :<span class="lineCov">     270962 : }</span></a>
<a name="909"><span class="lineNum">     909 </span>                :            : </a>
<a name="910"><span class="lineNum">     910 </span>                :<span class="lineCov">        924 : void SelectionResult::AddInputs(const std::set&lt;std::shared_ptr&lt;COutput&gt;&gt;&amp; inputs, bool subtract_fee_outputs)</span></a>
<a name="911"><span class="lineNum">     911 </span>                :            : {</a>
<a name="912"><span class="lineNum">     912 </span>                :            :     // As it can fail, combine inputs first</a>
<a name="913"><span class="lineNum">     913 </span>                :<span class="lineCov">        924 :     InsertInputs(inputs);</span></a>
<a name="914"><span class="lineNum">     914 </span>                :<span class="lineCov">        924 :     m_use_effective = !subtract_fee_outputs;</span></a>
<a name="915"><span class="lineNum">     915 </span>                :            : </a>
<a name="916"><span class="lineNum">     916 </span>                :<span class="lineCov">        924 :     m_weight += std::accumulate(inputs.cbegin(), inputs.cend(), 0, [](int sum, const auto&amp; coin) {</span></a>
<a name="917"><span class="lineNum">     917 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1088 times"> + </span>]:<span class="lineCov">       1088 :         return sum + std::max(coin-&gt;input_bytes, 0) * WITNESS_SCALE_FACTOR;</span></a>
<a name="918"><span class="lineNum">     918 </span>                :            :     });</a>
<a name="919"><span class="lineNum">     919 </span>                :<span class="lineCov">        924 : }</span></a>
<a name="920"><span class="lineNum">     920 </span>                :            : </a>
<a name="921"><span class="lineNum">     921 </span>                :<span class="lineCov">        154 : void SelectionResult::Merge(const SelectionResult&amp; other)</span></a>
<a name="922"><span class="lineNum">     922 </span>                :            : {</a>
<a name="923"><span class="lineNum">     923 </span>                :            :     // As it can fail, combine inputs first</a>
<a name="924"><span class="lineNum">     924 </span>                :<span class="lineCov">        154 :     InsertInputs(other.m_selected_inputs);</span></a>
<a name="925"><span class="lineNum">     925 </span>                :            : </a>
<a name="926"><span class="lineNum">     926 </span>                :<span class="lineCov">        154 :     m_target += other.m_target;</span></a>
<a name="927"><span class="lineNum">     927 </span>                :<span class="lineCov">        154 :     m_use_effective |= other.m_use_effective;</span></a>
<a name="928"><span class="lineNum">     928 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 154 times"> + </span>]:<span class="lineCov">        154 :     if (m_algo == SelectionAlgorithm::MANUAL) {</span></a>
<a name="929"><span class="lineNum">     929 </span>                :<span class="lineNoCov">          0 :         m_algo = other.m_algo;</span></a>
<a name="930"><span class="lineNum">     930 </span>                :            :     }</a>
<a name="931"><span class="lineNum">     931 </span>                :            : </a>
<a name="932"><span class="lineNum">     932 </span>                :<span class="lineCov">        154 :     m_weight += other.m_weight;</span></a>
<a name="933"><span class="lineNum">     933 </span>                :<span class="lineCov">        154 : }</span></a>
<a name="934"><span class="lineNum">     934 </span>                :            : </a>
<a name="935"><span class="lineNum">     935 </span>                :<span class="lineCov">      23311 : const std::set&lt;std::shared_ptr&lt;COutput&gt;&gt;&amp; SelectionResult::GetInputSet() const</span></a>
<a name="936"><span class="lineNum">     936 </span>                :            : {</a>
<a name="937"><span class="lineNum">     937 </span>                :<span class="lineCov">      23311 :     return m_selected_inputs;</span></a>
<a name="938"><span class="lineNum">     938 </span>                :            : }</a>
<a name="939"><span class="lineNum">     939 </span>                :            : </a>
<a name="940"><span class="lineNum">     940 </span>                :<span class="lineCov">       6550 : std::vector&lt;std::shared_ptr&lt;COutput&gt;&gt; SelectionResult::GetShuffledInputVector() const</span></a>
<a name="941"><span class="lineNum">     941 </span>                :            : {</a>
<a name="942"><span class="lineNum">     942 </span>                :<span class="lineCov">       6550 :     std::vector&lt;std::shared_ptr&lt;COutput&gt;&gt; coins(m_selected_inputs.begin(), m_selected_inputs.end());</span></a>
<a name="943"><span class="lineNum">     943 </span>                :<span class="lineCov">       6550 :     Shuffle(coins.begin(), coins.end(), FastRandomContext());</span></a>
<a name="944"><span class="lineNum">     944 </span>                :<span class="lineCov">       6550 :     return coins;</span></a>
<a name="945"><span class="lineNum">     945 </span>                :            : }</a>
<a name="946"><span class="lineNum">     946 </span>                :            : </a>
<a name="947"><span class="lineNum">     947 </span>                :<span class="lineCov">      10983 : bool SelectionResult::operator&lt;(SelectionResult other) const</span></a>
<a name="948"><span class="lineNum">     948 </span>                :            : {</a>
<a name="949"><span class="lineNum">     949 </span>                :<span class="lineCov">      10983 :     Assert(m_waste.has_value());</span></a>
<a name="950"><span class="lineNum">     950 </span>                :<span class="lineCov">      10983 :     Assert(other.m_waste.has_value());</span></a>
<a name="951"><span class="lineNum">     951 </span>                :            :     // As this operator is only used in std::min_element, we want the result that has more inputs when waste are equal.</a>
<a name="952"><span class="lineNum">     952 </span>  [<span class="branchCov" title="Branch 0 was taken 7904 times"> + </span><span class="branchCov" title="Branch 1 was taken 3079 times"> + </span><span class="branchCov" title="Branch 2 was taken 6846 times"> + </span><span class="branchCov" title="Branch 3 was taken 1058 times"> + </span> :<span class="lineCov">      10983 :     return *m_waste &lt; *other.m_waste || (*m_waste == *other.m_waste &amp;&amp; m_selected_inputs.size() &gt; other.m_selected_inputs.size());</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 94 times"> + </span><span class="branchCov" title="Branch 5 was taken 6752 times"> + </span>]
<a name="953"><span class="lineNum">     953 </span>                :            : }</a>
<a name="954"><span class="lineNum">     954 </span>                :            : </a>
<a name="955"><span class="lineNum">     955 </span>                :<span class="lineNoCov">          0 : std::string COutput::ToString() const</span></a>
<a name="956"><span class="lineNum">     956 </span>                :            : {</a>
<a name="957"><span class="lineNum">     957 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return strprintf(&quot;COutput(%s, %d, %d) [%s]&quot;, outpoint.hash.ToString(), outpoint.n, depth, FormatMoney(txout.nValue));</span></a>
<a name="958"><span class="lineNum">     958 </span>                :            : }</a>
<a name="959"><span class="lineNum">     959 </span>                :            : </a>
<a name="960"><span class="lineNum">     960 </span>                :<span class="lineCov">       6502 : std::string GetAlgorithmName(const SelectionAlgorithm algo)</span></a>
<a name="961"><span class="lineNum">     961 </span>                :            : {</a>
<a name="962"><span class="lineNum">     962 </span>  [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 4670 times"> + </span><span class="branchCov" title="Branch 2 was taken 1019 times"> + </span><span class="branchCov" title="Branch 3 was taken 33 times"> + </span> :<span class="lineCov">       6502 :     switch (algo)</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 760 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<a name="963"><span class="lineNum">     963 </span>                :            :     {</a>
<a name="964"><span class="lineNum">     964 </span>                :<span class="lineCov">         20 :     case SelectionAlgorithm::BNB: return &quot;bnb&quot;;</span></a>
<a name="965"><span class="lineNum">     965 </span>                :<span class="lineCov">       4670 :     case SelectionAlgorithm::KNAPSACK: return &quot;knapsack&quot;;</span></a>
<a name="966"><span class="lineNum">     966 </span>                :<span class="lineCov">       1019 :     case SelectionAlgorithm::SRD: return &quot;srd&quot;;</span></a>
<a name="967"><span class="lineNum">     967 </span>                :<span class="lineCov">         33 :     case SelectionAlgorithm::CG: return &quot;cg&quot;;</span></a>
<a name="968"><span class="lineNum">     968 </span>                :<span class="lineCov">        760 :     case SelectionAlgorithm::MANUAL: return &quot;manual&quot;;</span></a>
<a name="969"><span class="lineNum">     969 </span>                :            :     // No default case to allow for compiler to warn</a>
<a name="970"><span class="lineNum">     970 </span>                :            :     }</a>
<a name="971"><span class="lineNum">     971 </span>                :<span class="lineNoCov">          0 :     assert(false);</span></a>
<a name="972"><span class="lineNum">     972 </span>                :            : }</a>
<a name="973"><span class="lineNum">     973 </span>                :            : </a>
<a name="974"><span class="lineNum">     974 </span>                :<span class="lineCov">      25046 : CAmount SelectionResult::GetChange(const CAmount min_viable_change, const CAmount change_fee) const</span></a>
<a name="975"><span class="lineNum">     975 </span>                :            : {</a>
<a name="976"><span class="lineNum">     976 </span>                :            :     // change = SUM(inputs) - SUM(outputs) - fees</a>
<a name="977"><span class="lineNum">     977 </span>                :            :     // 1) With SFFO we don't pay any fees</a>
<a name="978"><span class="lineNum">     978 </span>                :            :     // 2) Otherwise we pay all the fees:</a>
<a name="979"><span class="lineNum">     979 </span>                :            :     //  - input fees are covered by GetSelectedEffectiveValue()</a>
<a name="980"><span class="lineNum">     980 </span>                :            :     //  - non_input_fee is included in m_target</a>
<a name="981"><span class="lineNum">     981 </span>                :            :     //  - change_fee</a>
<a name="982"><span class="lineNum">     982 </span>                :<span class="lineCov">      25046 :     const CAmount change = m_use_effective</span></a>
<a name="983"><span class="lineNum">     983 </span>        [<span class="branchCov" title="Branch 0 was taken 21969 times"> + </span><span class="branchCov" title="Branch 1 was taken 3077 times"> + </span>]:<span class="lineCov">      25046 :                            ? GetSelectedEffectiveValue() - m_target - change_fee</span></a>
<a name="984"><span class="lineNum">     984 </span>                :<span class="lineCov">       3077 :                            : GetSelectedValue() - m_target;</span></a>
<a name="985"><span class="lineNum">     985 </span>                :            : </a>
<a name="986"><span class="lineNum">     986 </span>        [<span class="branchCov" title="Branch 0 was taken 833 times"> + </span><span class="branchCov" title="Branch 1 was taken 24213 times"> + </span>]:<span class="lineCov">      25046 :     if (change &lt; min_viable_change) {</span></a>
<a name="987"><span class="lineNum">     987 </span>                :<span class="lineCov">        833 :         return 0;</span></a>
<a name="988"><span class="lineNum">     988 </span>                :            :     }</a>
<a name="989"><span class="lineNum">     989 </span>                :            : </a>
<a name="990"><span class="lineNum">     990 </span>                :            :     return change;</a>
<a name="991"><span class="lineNum">     991 </span>                :            : }</a>
<a name="992"><span class="lineNum">     992 </span>                :            : </a>
<a name="993"><span class="lineNum">     993 </span>                :            : } // namespace wallet</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="https://github.com/linux-test-project/lcov" target="_parent">LCOV version 1.16</a></td></tr>
  </table>
  <br>

</body>
</html>
